<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مواصفات نظام المدرسة الديناميكي (School Instance) + النظام المحاسبي</title>
  <style>
    body{font-family: Arial, Tahoma, "Segoe UI", sans-serif; line-height:1.7; margin:28px; color:#111}
    h1,h2,h3{margin:18px 0 10px}
    h1{font-size:24px}
    h2{font-size:18px; border-bottom:1px solid #ddd; padding-bottom:6px}
    h3{font-size:15px}
    .meta{background:#f6f6f6; padding:12px 14px; border:1px solid #e5e5e5; margin:14px 0}
    ul{margin:8px 0 12px}
    table{width:100%; border-collapse:collapse; margin:10px 0 16px}
    th,td{border:1px solid #d9d9d9; padding:8px; vertical-align:top}
    th{background:#fafafa}
    .note{background:#fff9e6; border:1px solid #ffe4a3; padding:10px 12px}
    .small{font-size:12px; color:#444}
    code{font-family: Consolas, monospace; font-size: 12px}
  </style>
</head>
<body>

<h1>مواصفات نظام المدرسة الديناميكي (School Instance) المدموج بالنظام المحاسبي</h1>

<div class="meta">
  <div><b>النطاق:</b> نسخة نظام مستقلة لكل مدرسة (Web-based) + قاعدة بيانات مستقلة + API للتطبيقات والمكتب.</div>
  <div><b>الفئات المستهدفة:</b> مدارس حكومية، أهلية (خاصة).</div>
  <div><b>التقنيات المستهدفة:</b> Backend: ASP.NET Core Web API — Frontend: Angular v20 — Mobile: تطبيق واحد متعدد المدارس.</div>
  <div class="small"><b>ملاحظة:</b> هذا المستند يصف نظام المدرسة فقط (School Instance). المالية تبقى داخل المدرسة ولا تُرفع لمكتب التربية.</div>
</div>

<h2>1) الهدف العام</h2>
<p>إنشاء نظام مدرسي إلكتروني متكامل يعمل كنسخة مستقلة لكل مدرسة، ويغطي التشغيل اليومي (طلاب/معلمين/حضور/درجات/جداول/أصول/كتب…)، ويشمل نظامًا محاسبيًا كاملاً داخل المدرسة (خصوصًا للمدارس الأهلية). كما يتيح للنظام إنتاج تقارير وإحصاءات رسمية وإرسال أجزاء محددة منها إلى نظام مكتب التربية عبر API بنقرة زر (بدون بيانات مالية).</p>

<h2>2) المبادئ (Key Principles)</h2>
<ul>
  <li><b>الاستقلالية:</b> لكل مدرسة قاعدة بيانات مستقلة ونطاق/رابط خاص.</li>
  <li><b>الديناميكية:</b> اختلاف نوع المدرسة (حكومي/أهلي) يُدار عبر إعدادات وتفعيل/تعطيل ميزات وسياسات.</li>
  <li><b>المالية محلية:</b> لا يتم إرسال أي بيانات مالية خارج المدرسة.</li>
  <li><b>الاعتماد والتدقيق:</b> أي تقرير أو نتائج تُرسل للمكتب تمر باعتماد مدير المدرسة وسجل تدقيق.</li>
  <li><b>القابلية للتوسع:</b> تصميم مناسب لعدد مدارس 100–300+ مع تحديثات ونشر متعدد النسخ.</li>
</ul>

<h2>3) المستخدمون داخل المدرسة (أمثلة أدوار شائعة قابلة للتخصيص)</h2>
<p>تختلف المسميات الوظيفية وتوزيع المهام من مدرسة لأخرى (بحسب الحجم، النوع، توفر الكادر، ونظام العمل). لذلك لا يعتمد النظام على أدوار ثابتة، بل يتيح لكل مدرسة <b>إنشاء الأدوار والصلاحيات من الصفر</b> وربط كل موظف بما يناسبه من مهام وصلاحيات ومسارات اعتماد.</p>
<p><b>مهم:</b> الجدول التالي أمثلة شائعة فقط لتسهيل الفهم، ولا يعني وجود أدوار افتراضية ثابتة داخل النظام. الصلاحيات الفعلية لأي موظف تعتمد على ما تُنشئه المدرسة من أدوار وصلاحيات ومسارات اعتماد.</p>
<table>
  <thead>
    <tr><th>الدور</th><th>المهام الرئيسية</th><th>ملاحظات</th></tr>
  </thead>
  <tbody>
    <tr><td>مدير المدرسة</td><td>اعتماد البيانات والتقارير، متابعة الأداء، (قد يتولى إدارة المستخدمين حسب سياسة المدرسة)</td><td>تُحدد صلاحياته وفق ما تُنشئه المدرسة في RBAC</td></tr>
    <tr><td>وكيل المدرسة</td><td>متابعة الطلاب والحضور والسلوك، إصدار تقارير تنفيذية</td><td>صلاحيات حسب التفويض</td></tr>
    <tr><td>شؤون الطلاب</td><td>القيد، النقل، التسكين، ملفات الطلاب، الوثائق والشهادات</td><td>لا صلاحيات مالية</td></tr>
    <tr><td>المرشد/الأخصائي</td><td>السلوك والانضباط، الإرشاد، المتابعة الصحية</td><td>صلاحيات على ملفات السلوك والصحة</td></tr>
    <tr><td>المعلم</td><td>التحضير الحصصي، إدخال الدرجات، الاطلاع على الجدول</td><td>نطاقه (Own) يُحدد حسب جدول حصصه المعتمد فقط</td></tr>
    <tr><td>محاسب المدرسة</td><td>الرسوم، القبض/الصرف، الرواتب (للأهلي)، التقارير المالية</td><td>مفصول عن الأكاديمي عبر RBAC</td></tr>
    <tr><td>مسؤول أصول/مخزن/مكتبة</td><td>الأصول والصيانة، الكتب والاستعارة، المخزون (إن تم تفعيله)</td><td>قد يرتبط مالياً (خاصة بالأهلي)</td></tr>
    <tr><td>مدخل بيانات</td><td>إدخال دون اعتماد</td><td>كل اعتماد يتم من مدير/مخول</td></tr>
  </tbody>
</table>

<h2>4) المدرسة وإعداداتها (تفصيلي)</h2>
<p>هذا القسم يوسّع المواصفات السابقة إلى مستوى يمكن البناء عليه مباشرة (شاشات/نماذج/سير عمل/قواعد).</p>

<h3>4.1 الإعدادات العامة للمدرسة (School Configuration)</h3>
<ul>
  <li><b>نوع المدرسة:</b> حكومي أو أهلي (يحدد تفعيل الرسوم/الرواتب افتراضيًا).</li>
  <li><b>المرحلة:</b> ابتدائي/إعدادي/ثانوي (تحديد الصفوف المتاحة وإعدادات الانتقال).</li>
  <li><b>نوع التعليم:</b> ذكور/إناث/مختلط.</li>
  <li><b>فترة العمل:</b> صباحية/مسائية/فترتين، مع إمكانية تحديد وقت بداية/نهاية لكل فترة.</li>
  <li><b>أيام الدوام:</b> 5 أو 6 أيام مع تحديد أيام الإجازة الأسبوعية.</li>
  <li><b>مخطط اليوم الدراسي:</b> عدد الحصص، مدة الحصة، فترات الراحة/الصلاة، أوقات البداية والنهاية.</li>
  <li><b>سياسة الحضور:</b> يومي أو حصصي، مع تعريف حالات الحضور المسموحة وقواعد احتساب الغياب.</li>
  <li><b>سياسة التقييم:</b> توزيع الدرجات (شهري/نصفي/نهائي) وإعدادات الإقفال ومن يملك صلاحية فتح الإقفال.</li>
  <li><b>سياسة الرسوم (للأهلي):</b> تفعيل الرسوم، قواعد الخصومات والإعفاءات، وما الذي يُمنع عند التعثر المالي.</li>
</ul>

<h2>5) إدارة المستخدمين والموظفين والصلاحيات (تفصيلي)</h2>

<h3>5.1 إدارة المستخدمين والصلاحيات (Users & RBAC)</h3>
<p>لأن توزيع المهام يختلف بين المدارس، فإن نظام الصلاحيات مبني على: <b>هيكل تنظيمي</b> + <b>مسميات وظيفية</b> + <b>أدوار (Roles)</b> + <b>قدرات/صلاحيات دقيقة (Permissions)</b> + <b>تفويض ومسارات اعتماد</b>. الهدف هو تمكين كل مدرسة من ضبط “من يعمل ماذا” دون تغيير في الكود، مع التأكيد أن <b>الأدوار تُنشأ داخل المدرسة من الصفر</b> عبر اختيار الصلاحيات المطلوبة لكل دور.</p>

<h3>5.1.0 بدء التشغيل (Bootstrap) — أول مستخدم إداري</h3>
<ul>
  <li><b>مستخدم مدير النظام المدرسي (School System Admin):</b> يتم إنشاؤه عند تفعيل نسخة المدرسة لأول مرة (أو يزوَّد للمدرسة من جهة النشر). هذا المستخدم لديه صلاحية إدارة المستخدمين والأدوار فقط لغرض تأسيس النظام.</li>
  <li><b>بعد التأسيس:</b> يمكن للمدرسة إنشاء أدوارها الخاصة بالكامل ثم تقييد حساب مدير النظام أو تحويله إلى دور إداري محدود حسب سياسة المدرسة.</li>
  <li><b>تسجيل تدقيق:</b> جميع عمليات التأسيس (إنشاء أدوار/منح صلاحيات/ربط مستخدمين) تُسجل في سجل التدقيق.</li>
</ul>

<h3>5.1.0.1 منشئ الأدوار (Role Builder) — كيف تبني المدرسة الأدوار من الصفر</h3>
<ol>
  <li><b>إنشاء قسم/وحدة (اختياري):</b> تعريف الأقسام التي تعمل بها المدرسة (شؤون الطلاب/الأكاديمي/الإرشاد/المالية/الأصول… أو أي أسماء أخرى).</li>
  <li><b>إنشاء مسمى وظيفي (اختياري):</b> تعريف مسميات الموظفين كما هي موجودة في المدرسة (وكيل، مسؤول نظام، سكرتير، مراقب اختبارات… إلخ).</li>
  <li><b>إنشاء دور جديد (Role):</b> اسم الدور + وصفه + هل هو دور إداري؟ + هل هو دور مالي؟</li>
  <li><b>اختيار الصلاحيات:</b> اختيار الصلاحيات من كتالوج الصلاحيات (قسم 5.1.3.1) مع تحديد النطاق (على بياناته فقط / على كامل المدرسة).</li>
  <li><b>تحديد قيود إضافية:</b> مثل: السماح بالتعديل قبل الإقفال فقط، أو منع الحذف، أو اشتراط اعتماد قبل النشر.</li>
  <li><b>تعيين مسار اعتماد للعمليات الحساسة:</b> ربط عمليات مثل (فتح إقفال درجات/اعتماد إرسال النتائج/اعتماد صرف) بمسار اعتماد خاص بهذه المدرسة.</li>
  <li><b>إسناد الدور للمستخدمين:</b> ربط المستخدم بالدور/الأدوار، وربطه بالأقسام. بالنسبة للمعلمين يتم ربط النطاق (Own) تلقائيًا عبر <b>الجدول المعتمد</b> (الحصص المُسندة لهم).</li>
</ol>

<h3>5.1.1 الهيكل التنظيمي داخل المدرسة (Organization Structure)</h3>
<ul>
  <li><b>الأقسام/الوحدات:</b> مثال (شؤون الطلاب، الشؤون الأكاديمية، الإرشاد، المالية، الأصول، المكتبة، تقنية معلومات…)، ويمكن للمدرسة إنشاء/تعديل/تعطيل أقسام حسب واقعها.</li>
  <li><b>المناصب الإدارية داخل القسم:</b> رئيس قسم/موظف/مساعد… (اختياري).</li>
  <li><b>الربط:</b> كل مستخدم يُربط بقسم (واحد أو أكثر) ويُحدد له “الدور داخل القسم”.</li>
</ul>

<h3>5.1.2 المسميات الوظيفية (Job Titles) مقابل الأدوار (Roles)</h3>
<ul>
  <li><b>المسمى الوظيفي:</b> وصف إداري/تعاقدي (مثل: وكيل، سكرتير، أمين مخزن، محاسب، مرشد، مسؤول نظم…)، وهو قابل للتعدد والتخصيص.</li>
  <li><b>الدور (Role):</b> حزمة صلاحيات تشغيلية داخل النظام (مثل: إدارة الطلاب، رصد الدرجات، اعتماد النتائج، إدارة الرسوم…).</li>
  <li><b>القاعدة:</b> يمكن لنفس المسمى الوظيفي أن يأخذ أدوارًا مختلفة من مدرسة لأخرى، كما يمكن لموظف واحد أن يحمل أكثر من دور.</li>
</ul>

<h3>5.1.3 نموذج الصلاحيات (Permission Model) — قدرات دقيقة</h3>
<p>بدل حصر الصلاحيات بأدوار ثابتة، يتم تعريف صلاحيات دقيقة على مستوى “قدرات” ثم تجميعها في أدوار. مثال على القدرات:</p>
<table>
  <thead>
    <tr><th>المجال</th><th>قدرات نموذجية (Examples)</th><th>ملاحظات</th></tr>
  </thead>
  <tbody>
    <tr><td>الطلاب</td><td>إنشاء طالب، تعديل ملف، تغيير الحالة، نقل داخلي، إنشاء ملف نقل خارجي، طباعة شهادات</td><td>قدرات منفصلة لمنع إعطاء صلاحيات حساسة لموظف إدخال</td></tr>
    <tr><td>الحضور</td><td>رصد حضور حصصي، رصد يومي، اعتماد التحضير، تعديل تحضير بعد الإغلاق</td><td>التعديل بعد الإغلاق يكون صلاحية استثنائية</td></tr>
    <tr><td>الدرجات</td><td>إدخال درجات، تعديل درجات، إقفال شهر، فتح إقفال، اعتماد فصل، اعتماد سنة</td><td>صلاحيات الإقفال/الفتح تُحصر غالبًا</td></tr>
    <tr><td>الجداول</td><td>إنشاء جدول، تعديل جدول، إصدار نسخة جديدة، نشر الجدول للمعلمين/الطلاب</td><td>يدعم تعدد الإصدارات</td></tr>
    <tr><td>السلوك/الإرشاد</td><td>تسجيل مخالفة، اعتماد إجراء، مشاهدة السجل الصحي، إضافة جلسة إرشاد</td><td>بيانات حساسة تحتاج تقييد</td></tr>
    <tr><td>الكتب</td><td>إضافة كتاب، تسليم، استرجاع، تسجيل غرامة تلف/فقد</td><td>الغرامة قد تُربط ماليًا للأهلي</td></tr>
    <tr><td>الأصول</td><td>إضافة أصل، فتح صيانة، اعتماد صيانة، أرشفة أصل</td><td>قد يتطلب اعتماد إداري</td></tr>
    <tr><td>المالية (داخل المدرسة)</td><td>تعريف رسوم، توليد مستحقات، تحصيل، سند صرف، اعتماد صرف، إعداد رواتب، اعتماد رواتب</td><td>مفصولة تمامًا ولا تُرفع للمكتب</td></tr>
    <tr><td>التقارير والإرسال</td><td>توليد تقارير، اعتماد تقرير، إرسال تقرير لمكتب التربية، إعادة إرسال بعد رفض</td><td>مرتبطة بمسارات الاعتماد</td></tr>
  </tbody>
</table>

<h3>5.1.3.1 كتالوج الصلاحيات (Permission Catalog) — هيكل وتفصيل</h3>
<p>الكتالوج التالي يمثل الصلاحيات التي يوفرها النظام. المدرسة لا تستخدم قوالب جاهزة، بل <b>تُنشئ أدوارها من الصفر</b> عبر اختيار الصلاحيات المناسبة. كل صلاحية يمكن تقييدها بنطاق:</p>
<ul>
  <li><b>Own:</b> بيانات مرتبطة بحصص المستخدم في <b>الجدول المعتمد</b> فقط (مثال: المعلم يرى ويدخل حضور/درجات حصصه فقط).</li>
  <li><b>Any:</b> أي بيانات داخل المدرسة (مثال: رئيس قسم يراجع كل الصفوف).</li>
  <li><b>AfterClose:</b> صلاحيات استثنائية بعد الإقفال (تُمنح نادرًا وتُسجل دائمًا في التدقيق).</li>
</ul>

<table>
  <thead>
    <tr><th>المجال</th><th>الصلاحية (Permission)</th><th>النطاق</th><th>الوصف</th><th>حساسية</th></tr>
  </thead>
  <tbody>
    <tr><td>المستخدمون</td><td>users.manage</td><td>Any</td><td>إنشاء/تعطيل المستخدمين وإعادة تعيين كلمات المرور</td><td>مرتفع</td></tr>
    <tr><td>الأدوار</td><td>roles.manage</td><td>Any</td><td>إنشاء/تعديل/حذف الأدوار وربط الصلاحيات</td><td>مرتفع</td></tr>
    <tr><td>الهيكل التنظيمي</td><td>org.manage</td><td>Any</td><td>إنشاء الأقسام والمسميات وربط الموظفين</td><td>مرتفع</td></tr>

    <tr><td>الطلاب</td><td>students.create</td><td>Any</td><td>إضافة طالب جديد (قيد أولي)</td><td>متوسط</td></tr>
    <tr><td>الطلاب</td><td>students.update</td><td>Any</td><td>تعديل بيانات الطالب الأساسية</td><td>متوسط</td></tr>
    <tr><td>الطلاب</td><td>students.view</td><td>Own/Any</td><td>عرض ملف الطالب</td><td>متوسط</td></tr>
    <tr><td>الطلاب</td><td>students.status.change</td><td>Any</td><td>تغيير الحالة الدراسية (مستمر/منقطع/منقول/موقوف)</td><td>مرتفع</td></tr>
    <tr><td>الطلاب</td><td>students.assign.class</td><td>Any</td><td>تسكين الطالب (صف/شعبة/فترة)</td><td>مرتفع</td></tr>
    <tr><td>الطلاب</td><td>students.documents.manage</td><td>Own/Any</td><td>رفع/حذف/تنزيل الوثائق الرقمية</td><td>مرتفع</td></tr>
    <tr><td>الطلاب</td><td>students.transfer.export</td><td>Any</td><td>إنشاء ملف نقل إلكتروني</td><td>مرتفع</td></tr>
    <tr><td>الطلاب</td><td>students.transfer.approve</td><td>Any</td><td>اعتماد ملف النقل قبل الإرسال</td><td>مرتفع</td></tr>

    <tr><td>المعلمين</td><td>teachers.create</td><td>Any</td><td>إضافة معلم/موظف</td><td>متوسط</td></tr>
    <tr><td>المعلمين</td><td>teachers.update</td><td>Any</td><td>تعديل ملف المعلم</td><td>متوسط</td></tr>
    <tr><td>المعلمين</td><td>teachers.assign.subjects</td><td>Any</td><td>إسناد مواد وصفوف للمعلم</td><td>مرتفع</td></tr>
    <tr><td>المعلمين</td><td>teachers.attendance.view</td><td>Own/Any</td><td>عرض حضور المعلمين</td><td>متوسط</td></tr>

    <tr><td>الجداول</td><td>timetable.manage</td><td>Any</td><td>إنشاء وتعديل الجداول الدراسية</td><td>مرتفع</td></tr>
    <tr><td>الجداول</td><td>timetable.publish</td><td>Any</td><td>نشر جدول جديد (إصدار) للمعلمين/الطلاب</td><td>مرتفع</td></tr>

    <tr><td>الحضور</td><td>attendance.students.record</td><td>Own/Any</td><td>رصد حضور الطلاب (حصصي/يومي حسب الإعداد)</td><td>متوسط</td></tr>
    <tr><td>الحضور</td><td>attendance.students.edit</td><td>Own/Any</td><td>تعديل التحضير قبل الإقفال</td><td>مرتفع</td></tr>
    <tr><td>الحضور</td><td>attendance.students.edit.afterClose</td><td>AfterClose</td><td>تعديل التحضير بعد الإقفال</td><td>مرتفع</td></tr>
    <tr><td>الحضور</td><td>attendance.excuses.manage</td><td>Any</td><td>إدارة الأعذار ومرفقاتها</td><td>مرتفع</td></tr>

    <tr><td>الدرجات</td><td>grades.enter</td><td>Own/Any</td><td>إدخال درجات لمادة/صف</td><td>مرتفع</td></tr>
    <tr><td>الدرجات</td><td>grades.edit</td><td>Own/Any</td><td>تعديل درجات قبل الإقفال مع سجل تدقيق</td><td>مرتفع</td></tr>
    <tr><td>الدرجات</td><td>grades.edit.afterClose</td><td>AfterClose</td><td>تعديل درجات بعد الإقفال (استثنائي)</td><td>مرتفع</td></tr>
    <tr><td>الدرجات</td><td>grades.close.month</td><td>Any</td><td>إقفال درجات الشهر</td><td>مرتفع</td></tr>
    <tr><td>الدرجات</td><td>grades.open.month</td><td>Any</td><td>فتح إقفال درجات الشهر (عادة عبر مسار اعتماد)</td><td>مرتفع</td></tr>
    <tr><td>الدرجات</td><td>grades.close.term</td><td>Any</td><td>إقفال الفصل (اعتماد نتائج الفصل)</td><td>مرتفع</td></tr>
    <tr><td>الدرجات</td><td>grades.close.year</td><td>Any</td><td>إقفال السنة (اعتماد نتائج السنة)</td><td>مرتفع</td></tr>

    <tr><td>السلوك/الإرشاد</td><td>discipline.record</td><td>Any</td><td>تسجيل مخالفة/ملاحظة إيجابية</td><td>متوسط</td></tr>
    <tr><td>السلوك/الإرشاد</td><td>discipline.actions.approve</td><td>Any</td><td>اعتماد إجراء/قرار سلوكي</td><td>مرتفع</td></tr>
    <tr><td>الصحة</td><td>health.view</td><td>Any</td><td>عرض السجل الصحي</td><td>مرتفع</td></tr>
    <tr><td>الصحة</td><td>health.manage</td><td>Any</td><td>تحديث السجل الصحي/زيارات العيادة</td><td>مرتفع</td></tr>

    <tr><td>الكتب</td><td>books.manage.inventory</td><td>Any</td><td>إدارة مخزون الكتب</td><td>متوسط</td></tr>
    <tr><td>الكتب</td><td>books.issue</td><td>Any</td><td>تسليم الكتب للطلاب</td><td>متوسط</td></tr>
    <tr><td>الكتب</td><td>books.return</td><td>Any</td><td>استلام الكتب من الطلاب</td><td>متوسط</td></tr>
    <tr><td>الكتب</td><td>books.fines.manage</td><td>Any</td><td>إدارة غرامات التلف/الفقد (قد تُربط ماليًا للأهلي)</td><td>مرتفع</td></tr>

    <tr><td>الأصول</td><td>assets.manage</td><td>Any</td><td>إضافة/تعديل الأصول</td><td>مرتفع</td></tr>
    <tr><td>الأصول</td><td>assets.maintenance.manage</td><td>Any</td><td>فتح/اعتماد طلبات الصيانة وتسجيل تكاليفها</td><td>مرتفع</td></tr>

    <tr><td>المالية</td><td>finance.fees.manage</td><td>Any</td><td>تعريف الرسوم والخصومات والإعفاءات</td><td>مرتفع</td></tr>
    <tr><td>المالية</td><td>finance.invoices.generate</td><td>Any</td><td>توليد مستحقات/فواتير للطلاب</td><td>مرتفع</td></tr>
    <tr><td>المالية</td><td>finance.receipts.collect</td><td>Any</td><td>تحصيل رسوم وإصدار إيصالات</td><td>مرتفع</td></tr>
    <tr><td>المالية</td><td>finance.payments.issue</td><td>Any</td><td>سندات صرف للمصروفات</td><td>مرتفع</td></tr>
    <tr><td>المالية</td><td>finance.payments.approve</td><td>Any</td><td>اعتماد الصرف (قد يكون مرحلة ضمن مسار اعتماد)</td><td>مرتفع</td></tr>
    <tr><td>الرواتب</td><td>payroll.run</td><td>Any</td><td>إعداد مسير الرواتب</td><td>مرتفع</td></tr>
    <tr><td>الرواتب</td><td>payroll.approve</td><td>Any</td><td>اعتماد مسير الرواتب</td><td>مرتفع</td></tr>

    <tr><td>التقارير</td><td>reports.generate</td><td>Own/Any</td><td>توليد التقارير داخل المدرسة</td><td>متوسط</td></tr>
    <tr><td>التقارير</td><td>reports.approve</td><td>Any</td><td>اعتماد التقارير قبل النشر/الإرسال</td><td>مرتفع</td></tr>
    <tr><td>الإرسال للمكتب</td><td>office.submit.results</td><td>Any</td><td>إرسال نتائج الفصل/السنة لمكتب التربية</td><td>مرتفع</td></tr>
    <tr><td>الإرسال للمكتب</td><td>office.submit.profile</td><td>Any</td><td>إرسال تقرير ملف المدرسة (المرافق/التجهيزات/القوى العاملة…)</td><td>مرتفع</td></tr>

    <tr><td>النقل</td><td>transport.manage</td><td>Any</td><td>إدارة الباصات/الموصلين/المسارات وربطها</td><td>مرتفع</td></tr>
    <tr><td>النقل</td><td>transport.assign.students</td><td>Any</td><td>ربط/فصل الطلاب بالباص (تسجيل/ملف طالب)</td><td>مرتفع</td></tr>
    <tr><td>النقل</td><td>transport.assign.staff</td><td>Any</td><td>ربط/فصل الموظفين/المعلمين بالباص (ملف موظف)</td><td>مرتفع</td></tr>
    <tr><td>النقل</td><td>transport.subscribe.self</td><td>Own</td><td>طلب/تحديث اشتراك الموظف لنفسه (إذا سمحت سياسة المدرسة)</td><td>متوسط</td></tr>
  </tbody>
</table>

<h3>5.1.4 التفويض والإنابة (Delegation & Coverage)</h3>
<ul>
  <li><b>تفويض مؤقت:</b> مدير المدرسة يمكنه تفويض صلاحيات محددة لمستخدم آخر لمدة زمنية (مثلاً أثناء إجازة).</li>
  <li><b>تغطية غياب:</b> تعيين بديل لرئيس قسم أو محاسب خلال فترة محددة مع تسجيل ذلك في سجل التدقيق.</li>
  <li><b>فصل الواجبات:</b> منع أن يكون نفس المستخدم (منشئ قيد مالي) هو نفسه (معتمد القيد) إن رغبت المدرسة بتطبيق ضوابط رقابية.</li>
</ul>

<h3>5.1.5 مسارات الاعتماد (Workflows) الديناميكية</h3>
<p>تختلف “سلسلة من يعتمد ماذا” بين المدارس. لذلك يتم تعريف مسارات اعتماد قابلة للتهيئة لكل عملية حساسة، مثل:</p>
<ul>
  <li><b>اعتماد تسجيل طالب:</b> (شؤون الطلاب → وكيل → مدير) أو (شؤون الطلاب → مدير) حسب المدرسة.</li>
  <li><b>فتح إقفال درجات:</b> (معلم → رئيس قسم → مدير) أو (معلم → مدير) حسب المدرسة.</li>
  <li><b>اعتماد إرسال النتائج لمكتب التربية:</b> (رئيس قسم أكاديمي → مدير) أو (وكيل → مدير) حسب المدرسة.</li>
  <li><b>اعتماد صرف مالي (للأهلي):</b> (محاسب → مدير) أو (محاسب → لجنة/وكيل → مدير) حسب المدرسة.</li>
</ul>

<h3>5.1.6 أمثلة واقعية لاختلاف توزيع المهام بين المدارس</h3>
<table>
  <thead>
    <tr><th>السيناريو</th><th>توزيع موظفين محتمل</th><th>كيف يدعمه النظام</th></tr>
  </thead>
  <tbody>
    <tr><td>مدرسة صغيرة</td><td>موظف واحد يقوم بشؤون الطلاب + الجداول + التقارير، ومعلم يقوم بإدخال درجات وحضور</td><td>إسناد عدة أدوار لنفس المستخدم مع حصر “الاعتماد النهائي” للمدير</td></tr>
    <tr><td>مدرسة متوسطة</td><td>شؤون طلاب مستقل، مسؤول جداول، مرشد، محاسب</td><td>أدوار منفصلة + مسارات اعتماد متعددة الأقسام</td></tr>
    <tr><td>مدرسة كبيرة</td><td>رؤساء أقسام (طلاب/أكاديمي/مالية/أصول) + لجان اعتماد</td><td>هيكل تنظيمي + تفويض + فصل واجبات + اعتمادات متعددة المراحل</td></tr>
  </tbody>
</table>

<table>
  <thead>
    <tr><th>الشاشة/الوظيفة</th><th>الوصف</th><th>ضوابط</th></tr>
  </thead>
  <tbody>
    <tr><td>المستخدمون</td><td>إنشاء مستخدم، تعطيل/تفعيل، إعادة تعيين كلمة المرور</td><td>تسجيل كل العمليات في سجل تدقيق</td></tr>
    <tr><td>الأدوار</td><td>تعريف دور (أي مسمى يختاره المستخدم)</td><td>لا توجد أدوار افتراضية ثابتة؛ تُنشئ المدرسة الأدوار من الصفر باختيار الصلاحيات</td></tr>
    <tr><td>الصلاحيات</td><td>منح/سحب صلاحيات على مستوى الوحدات والعمليات</td><td>منع منح صلاحيات مالية لغير المحاسب/المدير</td></tr>
    <tr><td>سياسة كلمات المرور</td><td>طول كلمة المرور، محاولة دخول، قفل حساب</td><td>إعدادات قابلة للضبط</td></tr>
  </tbody>
</table>

<h3>5.2 إدارة الموظفين والمعلمين (Staff & Teachers)</h3>
<p>هذا القسم يغطي دورة حياة موظفي المدرسة (معلمين/إداريين/مشرفين…)، وربطهم بالمستخدمين والأدوار، وربط المعلمين بالمواد والجدول. في المدارس الأهلية فقط يمكن تفعيل اشتراك النقل للموظفين اختياريًا.</p>

<h4>5.2.1 نموذج البيانات (Data Model) — الموظفين</h4>
<h4>5.2.1.1 موظف/معلم (StaffMember)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>staffId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>staffNumber</td><td>String</td><td>نعم</td><td>رقم وظيفي داخل المدرسة (فريد)</td></tr>
    <tr><td>fullName</td><td>String</td><td>نعم</td><td>الاسم</td></tr>
    <tr><td>gender</td><td>Enum</td><td>اختياري</td><td>ذكر/أنثى</td></tr>
    <tr><td>nationalId</td><td>String</td><td>اختياري</td><td>رقم الهوية</td></tr>
    <tr><td>phone</td><td>String</td><td>اختياري</td><td>رقم التواصل</td></tr>
    <tr><td>email</td><td>String</td><td>اختياري</td><td>البريد</td></tr>
    <tr><td>address</td><td>String</td><td>اختياري</td><td>العنوان</td></tr>
    <tr><td>jobTitleId</td><td>GUID/INT</td><td>اختياري</td><td>المسمى الوظيفي (من 5.1.2)</td></tr>
    <tr><td>departmentId</td><td>GUID/INT</td><td>اختياري</td><td>القسم/الوحدة (من 5.1.1)</td></tr>
    <tr><td>staffType</td><td>Enum</td><td>نعم</td><td>Teacher/Administrative/Support</td></tr>
    <tr><td>hireDate</td><td>Date</td><td>اختياري</td><td>تاريخ التعيين</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Active/Inactive/Terminated</td></tr>
    <tr><td>userId</td><td>GUID/INT</td><td>اختياري</td><td>ربط بحساب المستخدم إن كان لديه دخول للنظام</td></tr>
    <tr><td>transportMode</td><td>Enum</td><td>اختياري</td><td>None/Bus/PrivateCar/Walk/Other — للأهلي فقط، اختياري</td></tr>
  </tbody>
</table>

<h4>5.2.1.2 وثائق الموظف (StaffDocument)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>documentId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>staffId</td><td>GUID/INT</td><td>نعم</td><td>الموظف</td></tr>
    <tr><td>docType</td><td>Enum/String</td><td>نعم</td><td>هوية/مؤهل/عقد/أخرى</td></tr>
    <tr><td>fileName</td><td>String</td><td>نعم</td><td>اسم الملف</td></tr>
    <tr><td>storagePath</td><td>String</td><td>نعم</td><td>مسار التخزين</td></tr>
    <tr><td>uploadedAt</td><td>DateTime</td><td>نعم</td><td>وقت الرفع</td></tr>
  </tbody>
</table>

<h4>5.2.2 الشاشات (UI Screens) — الموظفين</h4>
<ul>
  <li><b>قائمة الموظفين:</b> بحث/فلترة (نشط/غير نشط، نوع، قسم، مسمى).</li>
  <li><b>إضافة موظف/معلم:</b> إدخال بيانات أساسية + ربط قسم/مسمى + نوع الموظف.</li>
  <li><b>ملف الموظف:</b> بيانات + وثائق + أدوار/صلاحيات + (للمعلم) مواد/صفوف + ارتباط بالجدول.</li>
  <li><b>ربط الموظف بحساب مستخدم:</b> إنشاء/ربط userId وتعيين الأدوار.</li>
  <li><b>النقل (للأهلي):</b> اختيار طريقة النقل للموظف. إذا اختير <b>Bus</b> يظهر اختيار (الباص/المسار/نقطة التجمع) مع سعة.</li>
</ul>

<h4>5.2.3 الصلاحيات (Permissions) — الموظفين</h4>
<ul>
  <li><b>إدارة الموظفين:</b> teachers.create / teachers.update (تُستخدم للمعلمين والموظفين حسب سياسة النظام).</li>
  <li><b>ربط أدوار الموظف:</b> users.manage / roles.manage.</li>
  <li><b>إسناد مواد/صفوف:</b> teachers.assign.subjects.</li>
  <li><b>النقل (للأهلي):</b> transport.assign.staff أو transport.subscribe.self إذا سمحت المدرسة confirm عبر إعداد.</li>
</ul>

<h4>5.2.4 قواعد العمل (Business Rules) — الموظفين</h4>
<ul>
  <li><b>رقم وظيفي فريد:</b> staffNumber لا يتكرر داخل المدرسة.</li>
  <li><b>ربط المعلم بالجدول:</b> صلاحيات Own للمعلم تُستخرج من الجدول المعتمد فقط.</li>
  <li><b>الفصل بين “ملف الموظف” و”حساب الدخول”:</b> قد يوجد موظف بدون userId (لا يستخدم النظام).</li>
  <li><b>النقل اختياري (للأهلي):</b> الموظف ليس ملزمًا بالباص. إذا اختير Bus يجب وجود تعيين فعال ضمن قسم النقل المدرسي (6.5) (StaffBusAssignment).</li>
</ul>

<h4>5.2.5 سير العمل (Workflows) — الموظفين</h4>
<ol>
  <li><b>إضافة موظف:</b> إدخال StaffMember ثم (اختياري) رفع الوثائق.</li>
  <li><b>إنشاء/ربط مستخدم:</b> إنشاء حساب دخول وربطه بـ staffId.</li>
  <li><b>تعيين الأدوار:</b> إسناد Roles حسب المدرسة + تحديد نطاق الصلاحيات.</li>
  <li><b>للمعلمين:</b> إسناد مواد/صفوف ثم إدخاله في الجدول واعتماد الجدول.</li>
  <li><b>تعطيل/إنهاء خدمة:</b> تحويل status إلى Inactive/Terminated مع سبب، وإلغاء صلاحية الدخول إن كان userId موجودًا.</li>
</ol>

<h4>5.2.6 سيناريوهات تفصيلية (Scenarios) — الموظفين</h4>
<h4>5.2.6.1 سيناريو: إضافة معلم وربطه بالجدول</h4>
<ol>
  <li>إنشاء StaffMember بنوع Teacher.</li>
  <li>إنشاء/ربط userId وتعيين Role للمعلم.</li>
  <li>إسناد مواد/صفوف للمعلم (teachers.assign.subjects).</li>
  <li>إضافته في إصدار جدول ثم اعتماد/نشر الجدول.</li>
</ol>

<h4>5.2.6.2 سيناريو: اشتراك موظف بالنقل المدرسي (للأهلي، اختياري)</h4>
<ol>
  <li>فتح ملف الموظف واختيار transportMode=Bus.</li>
  <li>اختيار busId (و routeId إن استخدم) وتحديد نقطة التجمع.</li>
  <li>التحقق من السعة ثم إنشاء StaffTransportPreference + StaffBusAssignment.</li>
</ol>

<h4>5.2.7 التقارير (Reports) — الموظفين</h4>
<ul>
  <li>كشف الموظفين حسب (نوع/قسم/مسمى/حالة).</li>
  <li>كشف أحمال المعلمين (حصص/مواد/شُعب) من الجدول المعتمد.</li>
  <li>للأهلي: كشف مشتركي النقل من الموظفين حسب باص/مسار.</li>
</ul>

<h4>5.2.8 التدقيق (Audit) — الموظفين</h4>
<ul>
  <li>تسجيل أي تغيير في StaffMember أو ربط userId أو تغيير أدوار/صلاحيات.</li>
  <li>تسجيل تعيين/إلغاء تعيين النقل (StaffBusAssignment) بسبب ووقت.</li>
</ul>

<h2>6) إدارة الطلاب (Students) — تفصيلي</h2>
<ul>
  <li><b>شاشة طلب تسجيل طالب جديد:</b> إدخال بيانات الطالب وولي الأمر وإرفاق الوثائق (شهادة ميلاد/بطاقة… إن توفرت).</li>
  <li><b>شاشة اعتماد الطلب:</b> مراجعة الطلب، رفض/قبول، تسجيل سبب الرفض، ثم تحويله إلى قيد رسمي.</li>
  <li><b>شاشة ملف الطالب:</b> بيانات أساسية + تعليمية + اجتماعية + صحية + تاريخ حالات (Audit Timeline).</li>
  <li><b>شاشة التسكين:</b> تحديد (السنة الدراسية، الصف، الشعبة، الفترة) مع منع التسكين المكرر.</li>
  <li><b>شاشة تغيير الحالة الدراسية:</b> مستمر/منقطع/منقول/موقوف، مع سبب وتاريخ بداية/نهاية.</li>
  <li><b>شاشة النقل الخارجي:</b> إنشاء ملف نقل إلكتروني + اعتماده + إرساله للمدرسة الجديدة (حسب آلية المشروع العامة).</li>
</ul>

<h4>6.1 نموذج البيانات (Data Model) — الطلاب</h4>
<p>الهدف هو توحيد البيانات بحيث تدعم اختلاف المدارس، وتدعم السجل التاريخي والتدقيق، وتسمح بوجود وثائق رقمية وطلبات اعتماد.</p>

<h4>6.1.1 كيان الطالب (Student)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>studentId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>schoolStudentNumber</td><td>String</td><td>نعم</td><td>رقم الطالب داخل المدرسة (فريد)</td></tr>
    <tr><td>fullName</td><td>String</td><td>نعم</td><td>الاسم الرباعي/الثلاثي حسب سياسة المدرسة</td></tr>
    <tr><td>gender</td><td>Enum</td><td>نعم</td><td>ذكر/أنثى</td></tr>
    <tr><td>birthDate</td><td>Date</td><td>اختياري</td><td>يخضع لضابط العمر (قابل للضبط)</td></tr>
    <tr><td>nationalId</td><td>String</td><td>اختياري</td><td>رقم وطني إن توفر</td></tr>
    <tr><td>address</td><td>String</td><td>اختياري</td><td>العنوان التفصيلي</td></tr>
    <tr><td>locationArea</td><td>String</td><td>اختياري</td><td>القرية/الحارة/العزلة</td></tr>
    <tr><td>guardianPrimaryId</td><td>GUID/INT</td><td>اختياري</td><td>ولي الأمر الأساسي (يمكن وجود أكثر من ولي)</td></tr>
    <tr><td>registrationStatus</td><td>Enum</td><td>نعم</td><td>Draft/Submitted/Approved/Rejected/Active/Inactive</td></tr>
    <tr><td>transportMode</td><td>Enum</td><td>اختياري</td><td>None/Bus/ParentDropoff/Walk/Other — للمدارس الأهلية غالبًا، ويمكن استخدامه كبيان إحصائي أيضًا</td></tr>
    <tr><td>createdAt</td><td>DateTime</td><td>نعم</td><td>وقت الإنشاء</td></tr>
    <tr><td>createdByUserId</td><td>GUID/INT</td><td>نعم</td><td>من أنشأ السجل</td></tr>
  </tbody>
</table>

<h4>6.1.5 تفضيل النقل للطالب (StudentTransportPreference)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>preferenceId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>studentId</td><td>GUID/INT</td><td>نعم</td><td>مرجع الطالب</td></tr>
    <tr><td>mode</td><td>Enum</td><td>نعم</td><td>Bus/ParentDropoff/Walk/Other</td></tr>
    <tr><td>notes</td><td>String</td><td>اختياري</td><td>ملاحظات (مثال: قريب من المدرسة، أو منطقة محددة)</td></tr>
    <tr><td>effectiveFrom</td><td>Date</td><td>اختياري</td><td>من تاريخ</td></tr>
    <tr><td>effectiveTo</td><td>Date</td><td>اختياري</td><td>إلى تاريخ</td></tr>
  </tbody>
</table>

<h4>6.1.6 تعيين النقل بالباص (StudentBusAssignment) — للأهلي فقط</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>assignmentId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>studentId</td><td>GUID/INT</td><td>نعم</td><td>الطالب</td></tr>
    <tr><td>busId</td><td>GUID/INT</td><td>نعم</td><td>الباص</td></tr>
    <tr><td>routeId</td><td>GUID/INT</td><td>اختياري</td><td>المسار/الخط إن كان مستخدمًا</td></tr>
    <tr><td>pickupPoint</td><td>String</td><td>اختياري</td><td>نقطة التجمع/الوصف</td></tr>
    <tr><td>dropoffPoint</td><td>String</td><td>اختياري</td><td>نقطة النزول/الوصف</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Active/Inactive</td></tr>
    <tr><td>startDate</td><td>Date</td><td>نعم</td><td>تاريخ بداية الاشتراك</td></tr>
    <tr><td>endDate</td><td>Date</td><td>اختياري</td><td>تاريخ النهاية</td></tr>
  </tbody>
</table>

<h4>6.1.2 كيان ولي الأمر (Guardian)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>guardianId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>fullName</td><td>String</td><td>نعم</td><td>اسم ولي الأمر</td></tr>
    <tr><td>relationship</td><td>Enum/String</td><td>اختياري</td><td>أب/أم/أخ/قريب…</td></tr>
    <tr><td>phone1</td><td>String</td><td>نعم</td><td>رقم التواصل الأساسي</td></tr>
    <tr><td>phone2</td><td>String</td><td>اختياري</td><td>رقم إضافي</td></tr>
    <tr><td>nationalId</td><td>String</td><td>اختياري</td><td>رقم وطني إن توفر</td></tr>
    <tr><td>isPrimary</td><td>Boolean</td><td>نعم</td><td>تحديد الولي الأساسي</td></tr>
  </tbody>
</table>

<h4>6.1.3 كيان التسكين/الالتحاق (Enrollment)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>enrollmentId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>studentId</td><td>GUID/INT</td><td>نعم</td><td>مرجع الطالب</td></tr>
    <tr><td>academicYearId</td><td>GUID/INT</td><td>نعم</td><td>السنة الدراسية</td></tr>
    <tr><td>gradeLevel</td><td>Enum/INT</td><td>نعم</td><td>الصف (1..)</td></tr>
    <tr><td>sectionId</td><td>GUID/INT</td><td>نعم</td><td>الشعبة</td></tr>
    <tr><td>shift</td><td>Enum</td><td>اختياري</td><td>صباح/مساء/فترتين</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Active/TransferredOut/Withdrawn/Suspended/Completed</td></tr>
    <tr><td>startDate</td><td>Date</td><td>نعم</td><td>تاريخ بداية الالتحاق</td></tr>
    <tr><td>endDate</td><td>Date</td><td>اختياري</td><td>تاريخ الانتهاء إن وجد</td></tr>
  </tbody>
</table>

<h4>6.1.4 الوثائق الرقمية (StudentDocument)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>documentId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>studentId</td><td>GUID/INT</td><td>نعم</td><td>مرجع الطالب</td></tr>
    <tr><td>docType</td><td>Enum/String</td><td>نعم</td><td>شهادة ميلاد/بطاقة/استمارة…</td></tr>
    <tr><td>fileName</td><td>String</td><td>نعم</td><td>اسم الملف</td></tr>
    <tr><td>mimeType</td><td>String</td><td>نعم</td><td>نوع الملف</td></tr>
    <tr><td>fileSize</td><td>Int</td><td>نعم</td><td>الحجم</td></tr>
    <tr><td>storagePath</td><td>String</td><td>نعم</td><td>مسار التخزين</td></tr>
    <tr><td>uploadedAt</td><td>DateTime</td><td>نعم</td><td>وقت الرفع</td></tr>
    <tr><td>uploadedByUserId</td><td>GUID/INT</td><td>نعم</td><td>من رفع الملف</td></tr>
  </tbody>
</table>

<h4>6.2 الشاشات (UI Screens) — تفاصيل الحقول والعمليات</h4>
<h4>6.2.1 شاشة طلب تسجيل طالب جديد</h4>
<ul>
  <li><b>الحقول الأساسية:</b> الاسم، الجنس، تاريخ الميلاد، العنوان، الهاتف (لولي الأمر)، بيانات ولي الأمر.</li>
  <li><b>حقول تعليمية:</b> المرحلة، الصف المطلوب، السنة الدراسية.</li>
  <li><b>النقل (للأهلي):</b> اختيار طريقة النقل (باص/يوصله أهله/يمشي/أخرى). إذا اختير <b>باص</b> يظهر اختيار (الباص/المسار/نقطة التجمع).</li>
  <li><b>الوثائق:</b> رفع ملفات (اختياري حسب سياسة المدرسة) مع تحديد نوع الوثيقة.</li>
  <li><b>أزرار:</b> حفظ كمسودة، إرسال للاعتماد، طباعة استمارة.</li>
  <li><b>تحقق:</b> منع تكرار طالب بنفس (الاسم + تاريخ الميلاد) إن فُعلت سياسة منع التكرار، والتحقق من ضابط العمر.</li>
  <li><b>صلاحيات:</b> students.create و students.documents.manage عند رفع ملفات.</li>
</ul>

<h4>6.2.2 شاشة اعتماد الطلب</h4>
<ul>
  <li><b>يعرض:</b> كل الطلبات بحالة Submitted مع إمكانية الفلترة (السنة، الصف، التاريخ).</li>
  <li><b>أزرار:</b> قبول، رفض مع سبب، إرجاع للتعديل.</li>
  <li><b>نتيجة القبول:</b> إنشاء رقم طالب داخل المدرسة + إنشاء سجل Student رسمي + تحويل الحالة إلى Approved ثم Active بعد التسكين.</li>
  <li><b>صلاحيات:</b> يمكن ربطها بمسار اعتماد (Workflow) وتكون صلاحية نهائية مثل students.status.change أو صلاحية خاصة لاعتماد التسجيل حسب المدرسة.</li>
</ul>

<h4>6.2.3 شاشة ملف الطالب</h4>
<ul>
  <li><b>تبويبات:</b> بيانات أساسية، ولي الأمر/التواصل، التسكين الحالي والسابق، الحضور، الدرجات، السلوك، الصحة، الوثائق، السجل الزمني (Timeline).</li>
  <li><b>قيود:</b> منع تعديل حقول حساسة بعد اعتماد الطالب إلا بصلاحية أعلى، وتسجيل كل التعديلات في التدقيق.</li>
</ul>

<h4>6.2.4 شاشة التسكين (Enrollment)</h4>
<ul>
  <li><b>المدخلات:</b> سنة دراسية + صف + شعبة + فترة.</li>
  <li><b>قيود:</b> لا يسمح بتسكينين نشطين لنفس الطالب في نفس السنة؛ منع التسكين على شعبة ممتلئة إن فُعلت السعة.</li>
  <li><b>صلاحيات:</b> students.assign.class</li>
</ul>

<h4>6.3 قواعد العمل (Business Rules) — الطلاب</h4>
<ul>
  <li><b>منع الازدواجية:</b> لا يسمح بوجود رقم طالب مكرر داخل المدرسة.</li>
  <li><b>حالة واحدة فعالة:</b> الطالب لا يكون Active في أكثر من Enrollment في نفس السنة.</li>
  <li><b>التعديل بعد الاعتماد:</b> بعض الحقول تتطلب صلاحية أعلى أو مسار اعتماد (حسب إعداد المدرسة).</li>
  <li><b>الوثائق:</b> أنواع الوثائق وقاعدة إلزاميتها تُضبط من إعدادات المدرسة.</li>
  <li><b>النقل اختياري:</b> يمكن أن يكون الطالب بدون باص (يوصله أهله/يمشي/قريب). إذا اختير Bus يجب وجود تعيين Active في StudentBusAssignment.</li>
</ul>

<h4>6.4 سيناريوهات تفصيلية (Scenarios) — الطلاب</h4>
<h4>6.4.1 سيناريو: تسجيل طالب (مسودة → إرسال → اعتماد → تسكين → تفعيل)</h4>
<ol>
  <li><b>إنشاء مسودة:</b> مستخدم لديه students.create يحفظ الطلب بحالة Draft.</li>
  <li><b>إرفاق وثائق:</b> إن لزم، يرفع الوثائق ويحدد نوعها (students.documents.manage).</li>
  <li><b>اختيار النقل:</b> تحديد طريقة النقل. إذا كانت Bus يتم اختيار الباص/المسار ونقطة التجمع وإنشاء StudentTransportPreference + StudentBusAssignment (Draft/Active حسب سياسة المدرسة).</li>
  <li><b>إرسال للاعتماد:</b> يتحول الطلب إلى Submitted ويُقفل بعض الحقول من التعديل.</li>
  <li><b>مراجعة واعتماد:</b> وفق مسار اعتماد المدرسة (قد يكون خطوة واحدة أو عدة خطوات).</li>
  <li><b>قبول:</b> النظام يُولد schoolStudentNumber ويُنشئ سجل Student رسمي.</li>
  <li><b>تسكين:</b> مسؤول التسكين يحدد الصف/الشعبة/الفترة (students.assign.class) وينشئ Enrollment بحالة Active.</li>
  <li><b>تفعيل نهائي:</b> يصبح الطالب ضمن كشوف الشعبة ويظهر في الحضور والدرجات.</li>
  <li><b>رفض:</b> يتحول الطلب إلى Rejected مع سبب، ويمكن إعادة فتحه كمسودة بإذن.</li>
</ol>

<h4>6.4.2 سيناريو: نقل طالب داخلي (تغيير شعبة/فترة)</h4>
<ol>
  <li><b>فتح طلب نقل داخلي:</b> تحديد الطالب + الشعبة الحالية + الشعبة الجديدة + سبب النقل.</li>
  <li><b>تحقق:</b> توفر سعة في الشعبة الجديدة + عدم تعارض مع فترة عمل الطالب.</li>
  <li><b>اعتماد (اختياري):</b> وفق مسار اعتماد المدرسة.</li>
  <li><b>تنفيذ:</b> إغلاق Enrollment السابق بتاريخ نهاية + إنشاء Enrollment جديد بتاريخ بداية.</li>
  <li><b>الأثر:</b> الحضور والدرجات ترتبطان بالحصص/الفترة؛ لا تُحذف البيانات القديمة.</li>
</ol>

<h4>6.4.3 سيناريو: نقل خارجي</h4>
<ol>
  <li><b>إنشاء ملف نقل:</b> students.transfer.export مع اختيار سبب النقل والجهة المستقبلة إن عُرفت.</li>
  <li><b>تجهيز الحزمة:</b> بيانات الطالب الأساسية + سجل التسكين + ملخص الحضور + ملخص الدرجات + الوثائق المسموح بها.</li>
  <li><b>اعتماد الملف:</b> students.transfer.approve ثم اعتماد مدير المدرسة إن اشترطت المدرسة.</li>
  <li><b>الإرسال:</b> إرسال ملف النقل عبر الآلية المتفق عليها بين نسخ المدارس (داخل المشروع).</li>
  <li><b>إغلاق:</b> يتحول Enrollment الحالي إلى TransferredOut بتاريخ محدد.</li>
</ol>

<h3>6.5 النقل المدرسي (School Transport) — للمدارس الأهلية</h3>
<ul>
  <li><b>إدارة الباصات:</b> تعريف الباص (رقم/لوحة/سعة/حالة).</li>
  <li><b>إدارة الموصلين:</b> تعريف الموصل/السائق (الاسم/الهاتف/الهوية/الرخصة إن وجدت) وربطه بباص.</li>
  <li><b>المسارات:</b> تعريف خطوط/مناطق (اختياري) ونقاط تجمع.</li>
  <li><b>ربط الطلاب:</b> عند تسجيل الطالب يمكن ربطه بباص <b>اختياريًا</b> حسب رغبة ولي الأمر.</li>
  <li><b>ربط الموظفين/المعلمين:</b> في المدارس الأهلية يمكن للموظف/المعلم الاشتراك بالباص <b>اختياريًا</b>.</li>
</ul>

<h4>6.5.1 نموذج البيانات (Data Model) — النقل</h4>
<h4>6.5.1.1 باص (Bus)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>busId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>busNumber</td><td>String</td><td>نعم</td><td>رقم داخلي للباص</td></tr>
    <tr><td>plateNumber</td><td>String</td><td>اختياري</td><td>رقم اللوحة</td></tr>
    <tr><td>capacity</td><td>Int</td><td>نعم</td><td>السعة القصوى</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Active/OutOfService</td></tr>
  </tbody>
</table>

<h4>6.5.1.2 موصل/سائق (TransportDriver)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>driverId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>fullName</td><td>String</td><td>نعم</td><td>اسم الموصل</td></tr>
    <tr><td>phone</td><td>String</td><td>نعم</td><td>رقم التواصل</td></tr>
    <tr><td>nationalId</td><td>String</td><td>اختياري</td><td>رقم الهوية</td></tr>
    <tr><td>licenseNumber</td><td>String</td><td>اختياري</td><td>رقم الرخصة</td></tr>
    <tr><td>isActive</td><td>Boolean</td><td>نعم</td><td>تفعيل/تعطيل</td></tr>
  </tbody>
</table>

<h4>6.5.1.3 ربط موصل بباص (BusDriverAssignment)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>assignmentId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>busId</td><td>GUID/INT</td><td>نعم</td><td>الباص</td></tr>
    <tr><td>driverId</td><td>GUID/INT</td><td>نعم</td><td>الموصل</td></tr>
    <tr><td>startDate</td><td>Date</td><td>نعم</td><td>بداية التعيين</td></tr>
    <tr><td>endDate</td><td>Date</td><td>اختياري</td><td>نهاية التعيين</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Active/Inactive</td></tr>
  </tbody>
</table>

<h4>6.5.1.4 مسار/خط (BusRoute) — اختياري</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>routeId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>name</td><td>String</td><td>نعم</td><td>اسم الخط/المنطقة</td></tr>
    <tr><td>busId</td><td>GUID/INT</td><td>اختياري</td><td>الباص الافتراضي إن كان مرتبطًا</td></tr>
    <tr><td>notes</td><td>String</td><td>اختياري</td><td>تفاصيل</td></tr>
  </tbody>
</table>

<h4>6.5.1.5 تفضيل نقل موظف (StaffTransportPreference) — للأهلي فقط</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>preferenceId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>staffId</td><td>GUID/INT</td><td>نعم</td><td>مرجع الموظف/المعلم (StaffMember)</td></tr>
    <tr><td>mode</td><td>Enum</td><td>نعم</td><td>Bus/PrivateCar/Walk/Other</td></tr>
    <tr><td>notes</td><td>String</td><td>اختياري</td><td>ملاحظات</td></tr>
    <tr><td>effectiveFrom</td><td>Date</td><td>اختياري</td><td>من تاريخ</td></tr>
    <tr><td>effectiveTo</td><td>Date</td><td>اختياري</td><td>إلى تاريخ</td></tr>
  </tbody>
</table>

<h4>6.5.1.6 تعيين نقل موظف بالباص (StaffBusAssignment) — للأهلي فقط</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>assignmentId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>staffId</td><td>GUID/INT</td><td>نعم</td><td>الموظف/المعلم</td></tr>
    <tr><td>busId</td><td>GUID/INT</td><td>نعم</td><td>الباص</td></tr>
    <tr><td>routeId</td><td>GUID/INT</td><td>اختياري</td><td>المسار/الخط إن كان مستخدمًا</td></tr>
    <tr><td>pickupPoint</td><td>String</td><td>اختياري</td><td>نقطة التجمع/الوصف</td></tr>
    <tr><td>dropoffPoint</td><td>String</td><td>اختياري</td><td>نقطة النزول/الوصف</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Active/Inactive</td></tr>
    <tr><td>startDate</td><td>Date</td><td>نعم</td><td>تاريخ بداية الاشتراك</td></tr>
    <tr><td>endDate</td><td>Date</td><td>اختياري</td><td>تاريخ النهاية</td></tr>
  </tbody>
</table>

<h4>6.5.2 الشاشات (UI Screens) — النقل</h4>
<ul>
  <li><b>إدارة الباصات:</b> إضافة/تعديل/تعطيل باص + السعة + الحالة.</li>
  <li><b>إدارة الموصلين:</b> إضافة موصل + بيانات التواصل + تفعيل/تعطيل.</li>
  <li><b>تعيين موصل لباص:</b> اختيار باص + موصل + تواريخ.</li>
  <li><b>إدارة المسارات:</b> تعريف خطوط ومناطق (اختياري).</li>
  <li><b>ربط الطلاب:</b> من ملف الطالب/التسجيل: تعيين باص + نقطة تجمع + حالة الاشتراك.</li>
  <li><b>ربط الموظفين:</b> من ملف الموظف: تعيين باص + نقطة تجمع + حالة الاشتراك.</li>
</ul>

<h4>6.5.3 قواعد العمل (Business Rules) — النقل</h4>
<ul>
  <li><b>اختياري:</b> الطالب ليس ملزمًا بالباص (قد يوصله أهله/يمشي/قريب).</li>
  <li><b>اشتراط التعيين عند اختيار Bus:</b> إذا mode=Bus يجب وجود StudentBusAssignment Active.</li>
  <li><b>سعة الباص:</b> لا يمكن تجاوز capacity للباص عند تفعيل الاشتراكات.</li>
  <li><b>موصل فعال:</b> الباص Active يجب أن يكون له BusDriverAssignment Active (إن كانت المدرسة تشترط ذلك).</li>
  <li><b>اشتراك الموظفين (للأهلي):</b> الموظف/المعلم يمكنه الاشتراك اختياريًا. إذا اختير Bus يجب وجود StaffBusAssignment Active.</li>
  <li><b>احتساب السعة:</b> السعة تُحسب على مجموع الاشتراكات النشطة (طلاب + موظفين) لنفس busId.</li>
</ul>

<h4>6.5.4 سيناريوهات تفصيلية (Scenarios) — النقل</h4>
<h4>6.5.4.1 سيناريو: إضافة باص وموصل وربطهما</h4>
<ol>
  <li>إضافة Bus وتحديد السعة والحالة.</li>
  <li>إضافة TransportDriver.</li>
  <li>إنشاء BusDriverAssignment وتفعيله.</li>
</ol>

<h4>6.5.4.2 سيناريو: ربط طالب بباص عند التسجيل (اختياري)</h4>
<ol>
  <li>اختيار transportMode=Bus داخل طلب التسجيل.</li>
  <li>اختيار busId (و routeId إن استخدم) وتحديد نقطة التجمع.</li>
  <li>التحقق من السعة ثم إنشاء StudentBusAssignment.</li>
</ol>

<h4>6.5.4.3 سيناريو: اشتراك موظف/معلم بالباص (اختياري)</h4>
<ol>
  <li>فتح ملف الموظف واختيار transportMode=Bus.</li>
  <li>اختيار busId (و routeId إن استخدم) وتحديد نقطة التجمع.</li>
  <li>التحقق من السعة ثم إنشاء StaffTransportPreference + StaffBusAssignment.</li>
</ol>

<h2>7) النظام الأكاديمي (Academic) — تفصيلي</h2>
<ul>
  <li><b>السنة الدراسية:</b> إنشاء سنة جديدة، تحديد تاريخ البداية والنهاية، تفعيل/تعطيل.</li>
  <li><b>الفصول:</b> فصل أول/فصل ثاني، مع إقفال كل فصل ومنع تعديل الدرجات بعد الإقفال إلا بصلاحية استثنائية.</li>
  <li><b>المواد:</b> تعريف المواد لكل مرحلة/صف، وتحديد عدد الحصص الأسبوعية المطلوبة.</li>
  <li><b>الشُعب والفصول:</b> إنشاء الشُعب وتحديد السعة، وربط الطلاب بها.</li>
</ul>

<h4>7.1 نموذج البيانات (Data Model) — الأكاديمي</h4>
<h4>7.1.1 السنة الدراسية (AcademicYear)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>academicYearId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>name</td><td>String</td><td>نعم</td><td>مثال: 2025-2026</td></tr>
    <tr><td>startDate</td><td>Date</td><td>نعم</td><td>بداية السنة</td></tr>
    <tr><td>endDate</td><td>Date</td><td>نعم</td><td>نهاية السنة</td></tr>
    <tr><td>isActive</td><td>Boolean</td><td>نعم</td><td>سنة فعالة واحدة فقط</td></tr>
  </tbody>
</table>

<h4>7.1.2 الفصل الدراسي (Term)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>termId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>academicYearId</td><td>GUID/INT</td><td>نعم</td><td>مرجع السنة</td></tr>
    <tr><td>termNumber</td><td>Int</td><td>نعم</td><td>1 أو 2</td></tr>
    <tr><td>startDate</td><td>Date</td><td>نعم</td><td>بداية الفصل</td></tr>
    <tr><td>endDate</td><td>Date</td><td>نعم</td><td>نهاية الفصل</td></tr>
    <tr><td>isClosed</td><td>Boolean</td><td>نعم</td><td>بعد الإقفال: منع تعديل الدرجات إلا AfterClose</td></tr>
  </tbody>
</table>

<h4>7.1.3 الصف والشعبة (GradeLevel / Section)</h4>
<p>الصف مستوى دراسي، والشعبة تقسيم داخلي داخل الصف (أ/ب/ج) مع إمكانية الربط بفترة (صباح/مساء).</p>

<h4>7.1.4 المواد (Subject) وخطة التقييم (Assessment Plan)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>subjectId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>name</td><td>String</td><td>نعم</td><td>اسم المادة</td></tr>
    <tr><td>gradeLevel</td><td>Int</td><td>نعم</td><td>الصف المرتبط</td></tr>
    <tr><td>weeklyLessons</td><td>Int</td><td>نعم</td><td>عدد الحصص الأسبوعية المطلوبة</td></tr>
    <tr><td>assessmentSchema</td><td>JSON/Struct</td><td>نعم</td><td>مكونات التقييم وأوزانها (حسب سياسة المدرسة)</td></tr>
  </tbody>
</table>

<h4>7.2 شاشات الأكاديمي (UI)</h4>
<ul>
  <li><b>إدارة السنة الدراسية:</b> إنشاء/تفعيل/إغلاق سنة، ومنع إنشاء بيانات على سنة مغلقة إلا بصلاحية.</li>
  <li><b>إدارة الفصول:</b> ضبط تواريخ الفصل، وإقفال الفصل بعد اكتمال الدرجات.</li>
  <li><b>إدارة المواد:</b> تحديد المواد للصفوف وعدد الحصص الأسبوعية وخطة التقييم.</li>
  <li><b>إدارة الشعب:</b> إنشاء الشعب وتحديد السعة والفترة واسم الشعبة.</li>
</ul>

<h4>7.3 قواعد العمل (Business Rules) — الأكاديمي</h4>
<ul>
  <li><b>سنة فعالة واحدة:</b> لا يسمح بأكثر من سنة نشطة في نفس الوقت.</li>
  <li><b>تعارض تواريخ:</b> تواريخ الفصول يجب أن تقع داخل نطاق السنة الدراسية.</li>
  <li><b>إقفال الفصل:</b> لا يسمح بإقفال الفصل إلا بعد اكتمال حد أدنى من الدرجات حسب سياسة المدرسة.</li>
</ul>

<h4>7.4 سيناريوهات تفصيلية (Scenarios) — الأكاديمي</h4>
<h4>7.4.1 سيناريو: بداية سنة دراسية جديدة</h4>
<ol>
  <li><b>إنشاء السنة:</b> إدخال الاسم والتواريخ.</li>
  <li><b>إنشاء الفصول:</b> ترم 1 وترم 2 مع تواريخ.</li>
  <li><b>تعريف المواد:</b> لكل صف تحديد المواد وعدد حصصها وخطة التقييم.</li>
  <li><b>تعريف الشعب:</b> لكل صف إنشاء شعب (أ/ب/ج) وربطها بفترة إن لزم.</li>
  <li><b>فتح التسجيل/التسكين:</b> السماح بإضافة الطلاب وتسكينهم على السنة الجديدة.</li>
</ol>

<h2>8) الجدول الدراسي (Timetable) — تفصيلي</h2>
<ul>
  <li><b>تعريف القوالب:</b> أيام الدوام، عدد الحصص/اليوم، مدة الحصة، فترات الراحة.</li>
  <li><b>إدخال متطلبات المواد:</b> عدد حصص مادة لكل صف أسبوعياً.</li>
  <li><b>توزيع المعلمين:</b> ربط معلم بمادة وصف/شعبة مع تحديد الحد اليومي/الأسبوعي.</li>
  <li><b>التحقق الآلي:</b> منع تعارض معلم/صف/قاعة في نفس الوقت.</li>
  <li><b>إصدارات الجدول:</b> كل تعديل ينتج (نسخة جدول) مع تاريخ بدء التطبيق للحفاظ على الأثر.</li>
</ul>

<h4>8.1 نموذج البيانات (Data Model) — الجدول</h4>
<h4>8.1.1 قالب اليوم الدراسي (DayTemplate)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>dayTemplateId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>daysOfWeek</td><td>List</td><td>نعم</td><td>أيام الدوام</td></tr>
    <tr><td>periodsPerDay</td><td>Int</td><td>نعم</td><td>عدد الحصص باليوم</td></tr>
    <tr><td>periodDurationMinutes</td><td>Int</td><td>نعم</td><td>مدة الحصة</td></tr>
    <tr><td>breaks</td><td>JSON/Struct</td><td>اختياري</td><td>فترات الراحة/الصلاة</td></tr>
  </tbody>
</table>

<h4>8.1.2 إصدار الجدول (TimetableVersion)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>timetableVersionId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>academicYearId</td><td>GUID/INT</td><td>نعم</td><td>السنة الدراسية</td></tr>
    <tr><td>termId</td><td>GUID/INT</td><td>اختياري</td><td>إن كان الجدول مرتبطًا بفصل</td></tr>
    <tr><td>versionNumber</td><td>Int</td><td>نعم</td><td>يزيد تلقائيًا</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Draft/Published/Archived</td></tr>
    <tr><td>effectiveFrom</td><td>Date</td><td>نعم</td><td>تاريخ بدء تطبيق الإصدار</td></tr>
    <tr><td>publishedAt</td><td>DateTime</td><td>اختياري</td><td>وقت النشر</td></tr>
    <tr><td>publishedByUserId</td><td>GUID/INT</td><td>اختياري</td><td>من نشر</td></tr>
  </tbody>
</table>

<h4>8.1.3 خانة/حصة في الجدول (TimetableSlot)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>slotId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>timetableVersionId</td><td>GUID/INT</td><td>نعم</td><td>مرجع الإصدار</td></tr>
    <tr><td>dayOfWeek</td><td>Enum</td><td>نعم</td><td>اليوم</td></tr>
    <tr><td>periodNumber</td><td>Int</td><td>نعم</td><td>رقم الحصة</td></tr>
    <tr><td>sectionId</td><td>GUID/INT</td><td>نعم</td><td>الشعبة</td></tr>
    <tr><td>subjectId</td><td>GUID/INT</td><td>نعم</td><td>المادة</td></tr>
    <tr><td>teacherId</td><td>GUID/INT</td><td>نعم</td><td>المعلم</td></tr>
    <tr><td>roomId</td><td>GUID/INT</td><td>اختياري</td><td>القاعة/المعمل</td></tr>
  </tbody>
</table>

<h4>8.2 قواعد التحقق (Validation Rules) — الجدول</h4>
<ul>
  <li><b>منع تعارض المعلم:</b> لا يمكن تعيين نفس المعلم لحصتين في نفس اليوم/الوقت ضمن نفس الإصدار.</li>
  <li><b>منع تعارض الشعبة:</b> لا يمكن أن يكون للشعبة أكثر من مادة في نفس اليوم/الحصة.</li>
  <li><b>منع تعارض القاعة:</b> إن كانت القاعات مفعلة، لا يمكن استخدام القاعة نفسها في نفس الوقت.</li>
  <li><b>تحقق المتطلبات:</b> يجب أن يغطي الجدول عدد حصص كل مادة أسبوعيًا حسب تعريف المادة.</li>
  <li><b>الأثر الزمني:</b> أي تغيير بعد النشر يتم بإصدار جديد EffectiveFrom، ولا يتم تعديل الإصدار المنشور مباشرة.</li>
</ul>

<h4>8.3 شاشات الجدول (UI)</h4>
<ul>
  <li><b>مصمم الجدول:</b> شبكة (أيام × حصص) لكل شعبة مع سحب وإفلات.</li>
  <li><b>إدارة الإصدارات:</b> قائمة الإصدارات (Draft/Published/Archived) وتحديد تاريخ التطبيق.</li>
  <li><b>كشف تعارضات:</b> شاشة تعارضات المعلم/الشعبة/القاعة مع اقتراحات.</li>
  <li><b>نشر الجدول:</b> نشر إصدار جديد وإشعار المعلمين/الطلاب.</li>
</ul>

<h4>8.4 سيناريوهات تفصيلية (Scenarios) — الجدول</h4>
<h4>8.4.1 سيناريو: إنشاء جدول جديد ثم نشره</h4>
<ol>
  <li><b>إنشاء إصدار مسودة:</b> timetable.manage ينشئ TimetableVersion بحالة Draft ويحدد effectiveFrom.</li>
  <li><b>إدخال الحصص:</b> بناء Slot لكل شعبة وفق متطلبات المواد.</li>
  <li><b>تشغيل التحقق:</b> النظام يعرض التعارضات ونواقص تغطية الحصص.</li>
  <li><b>المراجعة:</b> (اختياري) مسار اعتماد داخلي قبل النشر.</li>
  <li><b>النشر:</b> timetable.publish يحول الحالة إلى Published ويبدأ التطبيق من effectiveFrom.</li>
  <li><b>تحديث نطاق المعلمين (Own):</b> يُعاد اشتقاق نطاق كل معلم من Slots في الإصدار المنشور.</li>
</ol>

<h4>8.4.2 سيناريو: تغيير معلم لحصة بعد أسبوع من بدء الدراسة</h4>
<ol>
  <li><b>إنشاء إصدار جديد:</b> لا يتم تعديل الإصدار المنشور، بل إنشاء إصدار Draft جديد.</li>
  <li><b>تعديل Slots:</b> استبدال teacherId للحصص المطلوبة مع الحفاظ على باقي البيانات.</li>
  <li><b>تحديد تاريخ التطبيق:</b> effectiveFrom يبدأ من تاريخ الأسبوع القادم (أو تاريخ محدد).</li>
  <li><b>النشر:</b> نشر الإصدار الجديد.</li>
  <li><b>الأثر على الحضور/الدرجات:</b> قبل effectiveFrom يبقى نطاق المعلم القديم، وبعده ينتقل النطاق للمعلم الجديد حسب الجدول.</li>
</ol>

<h2>9) الحضور والانصراف (Attendance) — تفصيلي</h2>
<ul>
  <li><b>حضور الطلاب (حصصي):</b> لكل حصة يتم رصد الحالة (حاضر/غائب/متأخر/بعذر) مع سبب اختياري.</li>
  <li><b>حضور المعلمين:</b> حضور يومي (دخول/خروج) مع تأخير/انصراف مبكر (حسب سياسة المدرسة).</li>
  <li><b>الأعذار:</b> تسجيل عذر وتحويله إلى (بعذر) مع مرفق إن وجد.</li>
  <li><b>الإشعارات:</b> إشعار ولي الأمر عند الغياب/التأخر (موبايل/رسائل داخل النظام).</li>
</ul>

<h4>9.1 نموذج البيانات (Data Model) — الحضور</h4>
<p>الحضور مرتبط مباشرة بـ <b>الجدول المعتمد</b>. المعلم ضمن نطاق Own يرى فقط الحصص المسندة له في الجدول المنشور، ويُسجل الحضور لتلك الحصص فقط.</p>

<h4>9.1.1 جلسة حضور حصصي (AttendanceSession)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>attendanceSessionId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>timetableVersionId</td><td>GUID/INT</td><td>نعم</td><td>مرجع إصدار الجدول المنشور الذي تم اعتماد الحصة منه</td></tr>
    <tr><td>slotId</td><td>GUID/INT</td><td>نعم</td><td>مرجع الحصة (اليوم/الحصة/الشعبة/المادة/المعلم)</td></tr>
    <tr><td>sessionDate</td><td>Date</td><td>نعم</td><td>تاريخ اليوم</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Draft/Submitted/Closed</td></tr>
    <tr><td>recordedByUserId</td><td>GUID/INT</td><td>نعم</td><td>المعلم/المستخدم الذي سجّل الحضور</td></tr>
    <tr><td>submittedAt</td><td>DateTime</td><td>اختياري</td><td>وقت الإرسال/التثبيت</td></tr>
    <tr><td>closedAt</td><td>DateTime</td><td>اختياري</td><td>وقت الإقفال (وفق سياسة المدرسة)</td></tr>
  </tbody>
</table>

<h4>9.1.2 سجل حضور طالب في حصة (StudentAttendanceRecord)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>recordId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>attendanceSessionId</td><td>GUID/INT</td><td>نعم</td><td>مرجع الجلسة</td></tr>
    <tr><td>studentId</td><td>GUID/INT</td><td>نعم</td><td>الطالب</td></tr>
    <tr><td>attendanceStatus</td><td>Enum</td><td>نعم</td><td>Present/Absent/Late/Excused</td></tr>
    <tr><td>reasonCode</td><td>String/Enum</td><td>اختياري</td><td>سبب مختصر (مرض/سفر/ظرف…) حسب إعدادات المدرسة</td></tr>
    <tr><td>notes</td><td>String</td><td>اختياري</td><td>ملاحظات</td></tr>
    <tr><td>createdAt</td><td>DateTime</td><td>نعم</td><td>وقت التسجيل</td></tr>
  </tbody>
</table>

<h4>9.1.3 عذر (AttendanceExcuse)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>excuseId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>studentId</td><td>GUID/INT</td><td>نعم</td><td>الطالب</td></tr>
    <tr><td>fromDate</td><td>Date</td><td>نعم</td><td>من</td></tr>
    <tr><td>toDate</td><td>Date</td><td>نعم</td><td>إلى</td></tr>
    <tr><td>reason</td><td>String</td><td>نعم</td><td>سبب العذر</td></tr>
    <tr><td>attachmentDocumentId</td><td>GUID/INT</td><td>اختياري</td><td>مرفق (إن وجد)</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Draft/Submitted/Approved/Rejected</td></tr>
    <tr><td>approvedByUserId</td><td>GUID/INT</td><td>اختياري</td><td>المعتمد</td></tr>
  </tbody>
</table>

<h4>9.1.4 حضور المعلمين (TeacherAttendance)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>teacherAttendanceId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>teacherId</td><td>GUID/INT</td><td>نعم</td><td>المعلم/الموظف</td></tr>
    <tr><td>date</td><td>Date</td><td>نعم</td><td>اليوم</td></tr>
    <tr><td>checkInTime</td><td>Time</td><td>اختياري</td><td>وقت الدخول</td></tr>
    <tr><td>checkOutTime</td><td>Time</td><td>اختياري</td><td>وقت الخروج</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Present/Absent/Late/EarlyLeave/Excused</td></tr>
    <tr><td>notes</td><td>String</td><td>اختياري</td><td>ملاحظات</td></tr>
  </tbody>
</table>

<h4>9.2 الشاشات (UI Screens) — الحضور</h4>
<h4>9.2.1 شاشة حضور حصصي للمعلم (My Period Attendance)</h4>
<ul>
  <li><b>يعرض:</b> حصص اليوم للمعلم من الجدول المنشور فقط (Slots ضمن Own).</li>
  <li><b>اختيار حصة:</b> فتح الحصة (شعبة + مادة + رقم الحصة).</li>
  <li><b>قائمة الطلاب:</b> تُجلب من Enrollment النشط للشعبة في تاريخ الجلسة.</li>
  <li><b>المدخلات:</b> الحالة لكل طالب + سبب اختياري + ملاحظة.</li>
  <li><b>أزرار:</b> حفظ (Draft)، تثبيت/إرسال (Submitted)، طباعة كشف.</li>
  <li><b>قيود:</b> لا يمكن للمعلم تسجيل حضور لحصة ليست في الجدول المنشور، ولا لشعبة لا يدرّسها.</li>
  <li><b>صلاحيات:</b> attendance.students.record ضمن Own.</li>
</ul>

<h4>9.2.2 شاشة إدارة الأعذار</h4>
<ul>
  <li><b>إدخال عذر:</b> الطالب + المدة + السبب + مرفق (اختياري).</li>
  <li><b>الاعتماد:</b> يمكن أن يكون عبر مسار اعتماد (مرشد/وكيل/مدير) حسب المدرسة.</li>
  <li><b>الأثر:</b> عند اعتماد العذر، يمكن تحويل سجلات الغياب ضمن المدة إلى Excused آليًا حسب سياسة المدرسة.</li>
  <li><b>صلاحيات:</b> attendance.excuses.manage.</li>
</ul>

<h4>9.2.3 شاشة متابعة الحضور (للمخولين)</h4>
<ul>
  <li><b>تقارير مباشرة:</b> الغياب اليومي/الحصصي حسب صف/شعبة/مادة.</li>
  <li><b>التحقق من الالتزام:</b> حصص لم تُسجل بعد/معلمين لم يثبتوا التحضير.</li>
  <li><b>صلاحيات:</b> يمكن أن تكون Any مثل attendance.students.record.any (تُحقق عبر إعطاء Role نطاق Any للصلاحية).</li>
</ul>

<h4>9.3 قواعد العمل (Business Rules) — الحضور</h4>
<ul>
  <li><b>مصدر الحصص:</b> لا يُسمح بتسجيل حضور حصصي إلا إذا كانت الحصة موجودة في جدول منشور.</li>
  <li><b>قائمة الطلاب:</b> تُبنى من Enrollment النشط في وقت الجلسة (مع مراعاة النقل الداخلي وتاريخ بداية/نهاية التسكين).</li>
  <li><b>الإقفال:</b> تُحدد المدرسة سياسة إقفال الحضور (مثلاً إقفال يومي الساعة X أو إقفال بعد انتهاء الحصة).</li>
  <li><b>التعديل بعد الإقفال:</b> ممنوع إلا بصلاحية AfterClose (attendance.students.edit.afterClose) أو عبر مسار اعتماد مخصص.</li>
  <li><b>التأخير:</b> تعريف دقائق التأخير وحدودها (سياسة المدرسة) وتأثيرها على التقارير.</li>
  <li><b>الإشعارات:</b> سياسة من يستلم (ولي/طالب) ومتى (فوري/ملخص يومي) قابلة للضبط.</li>
</ul>

<h4>9.4 سيناريوهات تفصيلية (Scenarios) — الحضور</h4>
<h4>9.4.1 سيناريو: تسجيل حضور حصة (Draft → Submitted → Close)</h4>
<ol>
  <li><b>فتح الحصة:</b> المعلم يفتح حصته من قائمة حصص اليوم (من الجدول المنشور).</li>
  <li><b>تحميل الطلاب:</b> النظام يجلب قائمة طلاب الشعبة النشطين.</li>
  <li><b>إدخال الحالات:</b> وضع حاضر افتراضيًا (اختياري حسب الإعداد) ثم تعديل الغائب/المتأخر.</li>
  <li><b>حفظ مؤقت:</b> حفظ Draft يسمح بالعودة لاحقًا قبل التثبيت.</li>
  <li><b>تثبيت:</b> عند Submitted تُرسل إشعارات الغياب/التأخر إذا كانت مفعلة.</li>
  <li><b>إقفال:</b> عند وصول وقت الإقفال تصبح الجلسة Closed.</li>
</ol>

<h4>9.4.2 سيناريو: تصحيح حضور بعد الإقفال</h4>
<ol>
  <li><b>طلب تصحيح:</b> مستخدم مخول يفتح طلب تعديل بعد الإقفال ويحدد السبب.</li>
  <li><b>صلاحية/اعتماد:</b> إما صلاحية AfterClose مباشرة أو مسار اعتماد (مثلاً وكيل → مدير).</li>
  <li><b>تنفيذ التعديل:</b> يتم تعديل StudentAttendanceRecord مع تسجيل أثر (قبل/بعد) في سجل تدقيق الحضور.</li>
  <li><b>الإشعارات:</b> عند تغيير غياب إلى بعذر/حضور يمكن إرسال إشعار (اختياري).</li>
</ol>

<h4>9.4.3 سيناريو: وجود عذر معتمد يغطي أيام/حصص</h4>
<ol>
  <li><b>إدخال العذر:</b> attendance.excuses.manage يُنشئ عذرًا Draft ثم Submitted.</li>
  <li><b>اعتماد العذر:</b> وفق مسار المدرسة.</li>
  <li><b>تطبيق العذر:</b> عند Approval يقوم النظام بتحديث سجلات الغياب ضمن المدة إلى Excused (حسب سياسة المدرسة: حصصي/يومي).</li>
  <li><b>التقارير:</b> يظهر الغياب بعذر منفصلًا عن الغياب بدون عذر.</li>
</ol>

<h2>10) الدرجات والتقييم (Grades) — تفصيلي</h2>
<ul>
  <li><b>هيكل الدرجات:</b> تعريف مكونات التقييم (واجب/شفهي/مواظبة/اختبار تحريري/نصفي/نهائي) وأوزانها.</li>
  <li><b>الإدخال الجماعي:</b> إدخال درجات صف كامل لمادة محددة مع تحقق من حدود الدرجة.</li>
  <li><b>سجل التعديل:</b> كل تعديل على درجة يسجل (المستخدم/الوقت/القيمة قبل وبعد/السبب إن طُلب).</li>
  <li><b>إقفال الرصد:</b> قفل درجات الشهر ثم الفصل، ومنع التعديل بعد القفل إلا بصلاحية استثنائية.</li>
  <li><b>المخرجات:</b> كشف درجات الطالب، كشف درجات الصف، الأوائل، التحليل حسب مادة/صف.</li>
</ul>

<h4>10.1 نموذج البيانات (Data Model) — الدرجات</h4>
<p>الدرجات مرتبطة بالحصص/المادة/الشعبة/الفترة. نطاق المعلم (Own) يعني: يمكنه إدخال/تعديل درجات فقط للحصص المسندة له في الجدول المنشور.</p>

<h4>10.1.1 مخطط التقييم (AssessmentSchema)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>schemaId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>gradeLevel</td><td>Int</td><td>نعم</td><td>الصف</td></tr>
    <tr><td>subjectId</td><td>GUID/INT</td><td>نعم</td><td>المادة</td></tr>
    <tr><td>termId</td><td>GUID/INT</td><td>نعم</td><td>الفصل</td></tr>
    <tr><td>components</td><td>List</td><td>نعم</td><td>قائمة مكونات (اسم، حد أعلى، وزن، هل هو إلزامي)</td></tr>
    <tr><td>totalMax</td><td>Decimal</td><td>نعم</td><td>المجموع الأعلى النهائي</td></tr>
    <tr><td>roundingPolicy</td><td>Enum</td><td>اختياري</td><td>قواعد التقريب (حسب المدرسة)</td></tr>
  </tbody>
</table>

<h4>10.1.2 دفتر درجات (Gradebook) حسب شعبة/مادة/فصل</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>gradebookId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>academicYearId</td><td>GUID/INT</td><td>نعم</td><td>السنة</td></tr>
    <tr><td>termId</td><td>GUID/INT</td><td>نعم</td><td>الفصل</td></tr>
    <tr><td>sectionId</td><td>GUID/INT</td><td>نعم</td><td>الشعبة</td></tr>
    <tr><td>subjectId</td><td>GUID/INT</td><td>نعم</td><td>المادة</td></tr>
    <tr><td>teacherId</td><td>GUID/INT</td><td>نعم</td><td>المعلم (حسب الجدول المنشور)</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Open/MonthClosed/TermClosed/YearClosed</td></tr>
  </tbody>
</table>

<h4>10.1.3 إدخال درجة (StudentGradeEntry)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>entryId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>gradebookId</td><td>GUID/INT</td><td>نعم</td><td>مرجع دفتر الدرجات</td></tr>
    <tr><td>studentId</td><td>GUID/INT</td><td>نعم</td><td>الطالب</td></tr>
    <tr><td>componentKey</td><td>String</td><td>نعم</td><td>مكون التقييم (واجب/شفهي…)</td></tr>
    <tr><td>value</td><td>Decimal</td><td>اختياري</td><td>الدرجة (قد تكون Null قبل الإدخال)</td></tr>
    <tr><td>maxValue</td><td>Decimal</td><td>نعم</td><td>الحد الأعلى للمكون</td></tr>
    <tr><td>enteredByUserId</td><td>GUID/INT</td><td>نعم</td><td>من أدخل</td></tr>
    <tr><td>enteredAt</td><td>DateTime</td><td>نعم</td><td>وقت الإدخال</td></tr>
  </tbody>
</table>

<h4>10.1.4 سجل تغييرات الدرجات (GradeChangeLog)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>changeId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>entryId</td><td>GUID/INT</td><td>نعم</td><td>الدرجة المتغيرة</td></tr>
    <tr><td>oldValue</td><td>Decimal</td><td>اختياري</td><td>قبل</td></tr>
    <tr><td>newValue</td><td>Decimal</td><td>اختياري</td><td>بعد</td></tr>
    <tr><td>changedByUserId</td><td>GUID/INT</td><td>نعم</td><td>من غيّر</td></tr>
    <tr><td>changedAt</td><td>DateTime</td><td>نعم</td><td>وقت التغيير</td></tr>
    <tr><td>reason</td><td>String</td><td>اختياري</td><td>سبب (قد يصبح إلزاميًا بعد الإقفال)</td></tr>
    <tr><td>changeContext</td><td>Enum</td><td>نعم</td><td>BeforeClose/AfterClose</td></tr>
  </tbody>
</table>

<h4>10.2 الشاشات (UI Screens) — الدرجات</h4>
<h4>10.2.1 شاشة دفتر الدرجات للمعلم (My Gradebook)</h4>
<ul>
  <li><b>يعرض:</b> دفاتر الدرجات التي تخص المعلم من الجدول المنشور (شعبة/مادة/فصل) ضمن Own.</li>
  <li><b>قائمة الطلاب:</b> من Enrollment النشط للشعبة.</li>
  <li><b>أعمدة الدرجات:</b> حسب AssessmentSchema (مكونات التقييم).</li>
  <li><b>إدخال جماعي:</b> إدخال سريع مع تحقق لحظي من الحدود.</li>
  <li><b>أزرار:</b> حفظ، إرسال للمراجعة (اختياري)، طباعة كشف.</li>
  <li><b>صلاحيات:</b> grades.enter و grades.edit ضمن Own.</li>
</ul>

<h4>10.2.2 شاشة الإقفال والفتح</h4>
<ul>
  <li><b>إقفال الشهر:</b> grades.close.month على مستوى شعبة/مادة أو على مستوى المدرسة حسب سياسة المدرسة.</li>
  <li><b>فتح الإقفال:</b> grades.open.month مع سبب وتسجيل تدقيق، وغالبًا عبر مسار اعتماد.</li>
  <li><b>إقفال الفصل/السنة:</b> grades.close.term و grades.close.year بعد اكتمال الدرجات.</li>
</ul>

<h4>10.2.3 شاشة مراجعة التدقيق (Audit Review)</h4>
<ul>
  <li><b>يعرض:</b> كل تغييرات الدرجات مع قبل/بعد، ومن قام، والوقت، وهل كان بعد الإقفال.</li>
  <li><b>الفلترة:</b> طالب/شعبة/مادة/فترة/معلم.</li>
</ul>

<h4>10.3 قواعد العمل (Business Rules) — الدرجات</h4>
<ul>
  <li><b>مصدر الصلاحية Own:</b> المعلم لا يرى/لا يعدل إلا دفاتر مرتبطة بحصصه في الجدول المنشور.</li>
  <li><b>حدود الدرجات:</b> لا يسمح بإدخال قيمة خارج 0..maxValue.</li>
  <li><b>الاكتمال قبل الإقفال:</b> سياسة المدرسة تحدد ما إذا كان يسمح بالإقفال مع درجات ناقصة.</li>
  <li><b>التعديل بعد الإقفال:</b> ممنوع إلا بصلاحية AfterClose (grades.edit.afterClose) أو عبر مسار اعتماد مع إلزام سبب.</li>
  <li><b>تغيير المعلم في الجدول:</b> التغيير يسري على الحصص من effectiveFrom في الإصدار الجديد؛ لا يغيّر تاريخ إدخالات سابقة.</li>
  <li><b>الحساب النهائي:</b> يحتسب المجموع حسب الأوزان، مع تطبيق سياسة التقريب.</li>
</ul>

<h4>10.4 سيناريوهات تفصيلية (Scenarios) — الدرجات</h4>
<h4>10.4.1 سيناريو: إدخال درجات لمادة وشعبة</h4>
<ol>
  <li><b>فتح دفتر الدرجات:</b> المعلم يختار الشعبة/المادة من قائمة دفاتره.</li>
  <li><b>تحميل الطلاب:</b> حسب Enrollment النشط.</li>
  <li><b>إدخال القيم:</b> لكل مكون (واجب/شفهي…) مع تحقق الحدود.</li>
  <li><b>حفظ:</b> تحديث StudentGradeEntry وتسجيل GradeChangeLog عند التعديل.</li>
  <li><b>مراجعة (اختياري):</b> إذا المدرسة تشترط مراجعة رئيس قسم قبل الإقفال، تُرسل للمراجعة.</li>
</ol>

<h4>10.4.2 سيناريو: إقفال درجات الشهر</h4>
<ol>
  <li><b>تحقق جاهزية:</b> النظام يحسب نسبة اكتمال الدرجات ويعرض نواقص إن وجدت.</li>
  <li><b>تنفيذ الإقفال:</b> مستخدم مخول grades.close.month يُقفل الشهر (على دفاتر محددة أو على مستوى المدرسة).</li>
  <li><b>الأثر:</b> يمنع تعديل درجات الشهر إلا AfterClose/فتح إقفال.</li>
  <li><b>تسجيل تدقيق:</b> تسجيل من أغلق ومتى ونطاق الإغلاق.</li>
</ol>

<h4>10.4.3 سيناريو: فتح إقفال درجات (مع سبب)</h4>
<ol>
  <li><b>طلب فتح:</b> مستخدم يطلب فتح الإقفال ويحدد السبب والدفاتر المتأثرة.</li>
  <li><b>اعتماد:</b> وفق مسار المدرسة (مثلاً رئيس قسم → مدير) أو صلاحية مباشرة.</li>
  <li><b>فتح:</b> grades.open.month يفتح الإقفال لفترة محددة (مدة زمنية) إن رغبت المدرسة.</li>
  <li><b>إعادة الإقفال:</b> بعد إكمال التصحيح يتم إعادة الإقفال وإغلاق نافذة التعديل.</li>
</ol>

<h4>10.4.4 سيناريو: تعديل درجة بعد الإقفال (استثنائي)</h4>
<ol>
  <li><b>التحقق من الصلاحية:</b> grades.edit.afterClose أو وجود فتح إقفال نشط.</li>
  <li><b>إلزام السبب:</b> النظام يطلب reason ويضع changeContext=AfterClose.</li>
  <li><b>تنفيذ:</b> تحديث القيمة وتسجيل GradeChangeLog.</li>
  <li><b>التقارير:</b> يظهر التعديل في تقارير التدقيق وقد يتطلب اعتماد لاحق حسب المدرسة.</li>
</ol>

<h2>11) السلوك والإرشاد والصحة — تفصيلي</h2>
<ul>
  <li><b>السلوك:</b> مخالفات/ملاحظات إيجابية مع تصنيف، وإشعار ولي الأمر، وتقرير تراكمي للطالب.</li>
  <li><b>الإرشاد:</b> جلسات إرشادية، توصيات، متابعة.</li>
  <li><b>الصحة:</b> حالات مزمنة، زيارات العيادة، أدوية/ملاحظات، تقارير صحية مختصرة.</li>
</ul>

<h4>11.1 نموذج البيانات (Data Model) — السلوك/الإرشاد/الصحة</h4>
<h4>11.1.1 سجل سلوك (DisciplineCase)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>caseId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>studentId</td><td>GUID/INT</td><td>نعم</td><td>الطالب</td></tr>
    <tr><td>caseType</td><td>Enum</td><td>نعم</td><td>Negative/Positive</td></tr>
    <tr><td>category</td><td>String/Enum</td><td>نعم</td><td>تصنيف (تأخر/غياب/سلوك/واجب…)</td></tr>
    <tr><td>severity</td><td>Enum</td><td>اختياري</td><td>Low/Medium/High (حسب سياسة المدرسة)</td></tr>
    <tr><td>description</td><td>String</td><td>نعم</td><td>وصف الواقعة</td></tr>
    <tr><td>occurredAt</td><td>DateTime</td><td>نعم</td><td>وقت/تاريخ الواقعة</td></tr>
    <tr><td>reportedByUserId</td><td>GUID/INT</td><td>نعم</td><td>من سجّل الواقعة</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Draft/Submitted/Approved/Rejected/Closed</td></tr>
    <tr><td>approvedByUserId</td><td>GUID/INT</td><td>اختياري</td><td>من اعتمد</td></tr>
    <tr><td>guardianNotified</td><td>Boolean</td><td>نعم</td><td>هل تم إشعار ولي الأمر</td></tr>
  </tbody>
</table>

<h4>11.1.2 إجراء/عقوبة/خطة متابعة (DisciplineAction)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>actionId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>caseId</td><td>GUID/INT</td><td>نعم</td><td>مرجع الحالة</td></tr>
    <tr><td>actionType</td><td>String/Enum</td><td>نعم</td><td>تنبيه/استدعاء ولي/تعهد/حرمان نشاط…</td></tr>
    <tr><td>details</td><td>String</td><td>اختياري</td><td>تفاصيل الإجراء</td></tr>
    <tr><td>dueDate</td><td>Date</td><td>اختياري</td><td>موعد متابعة</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Planned/Done/Cancelled</td></tr>
    <tr><td>approvedByUserId</td><td>GUID/INT</td><td>اختياري</td><td>اعتماد الإجراء إذا كان يتطلب اعتماد</td></tr>
  </tbody>
</table>

<h4>11.1.3 جلسة إرشاد (CounselingSession)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>sessionId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>studentId</td><td>GUID/INT</td><td>نعم</td><td>الطالب</td></tr>
    <tr><td>sessionDate</td><td>DateTime</td><td>نعم</td><td>تاريخ الجلسة</td></tr>
    <tr><td>topic</td><td>String</td><td>نعم</td><td>موضوع الجلسة</td></tr>
    <tr><td>notes</td><td>String</td><td>اختياري</td><td>ملاحظات (مقيدة الصلاحية)</td></tr>
    <tr><td>recommendations</td><td>String</td><td>اختياري</td><td>توصيات</td></tr>
    <tr><td>createdByUserId</td><td>GUID/INT</td><td>نعم</td><td>المرشد/المستخدم</td></tr>
  </tbody>
</table>

<h4>11.1.4 السجل الصحي (StudentHealthRecord)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>healthRecordId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>studentId</td><td>GUID/INT</td><td>نعم</td><td>الطالب</td></tr>
    <tr><td>chronicConditions</td><td>String</td><td>اختياري</td><td>حالات مزمنة</td></tr>
    <tr><td>allergies</td><td>String</td><td>اختياري</td><td>حساسية</td></tr>
    <tr><td>medications</td><td>String</td><td>اختياري</td><td>أدوية</td></tr>
    <tr><td>notes</td><td>String</td><td>اختياري</td><td>ملاحظات صحية (حساسة)</td></tr>
    <tr><td>updatedAt</td><td>DateTime</td><td>نعم</td><td>آخر تحديث</td></tr>
  </tbody>
</table>

<h4>11.2 الشاشات (UI Screens)</h4>
<ul>
  <li><b>شاشة تسجيل واقعة سلوك:</b> اختيار الطالب + تصنيف + شدة + وصف + حفظ/إرسال للاعتماد + إشعار ولي الأمر (حسب السياسة).</li>
  <li><b>شاشة اعتماد إجراء سلوكي:</b> مراجعة الحالة والإجراء المقترح ثم اعتماد/رفض مع سبب.</li>
  <li><b>شاشة سجل الطالب السلوكي:</b> خط زمني (Timeline) للحالات مع فلاتر.</li>
  <li><b>شاشة جلسات الإرشاد:</b> إضافة جلسة + توصيات + متابعة + طباعة ملخص (إن سمحت الصلاحيات).</li>
  <li><b>شاشة السجل الصحي:</b> عرض/تحديث السجل الصحي مع تقييد شديد للصلاحيات.</li>
</ul>

<h4>11.3 قواعد العمل (Business Rules)</h4>
<ul>
  <li><b>الخصوصية:</b> بيانات الإرشاد والصحة تُصنّف حساسة ولا تُتاح إلا لأدوار محددة.</li>
  <li><b>الاعتماد:</b> يمكن للمدرسة فرض اعتماد للحالات السلوكية أو للإجراءات (discipline.actions.approve).</li>
  <li><b>الإشعارات:</b> سياسة إشعار ولي الأمر (فوري/بعد الاعتماد/ملخص) قابلة للضبط.</li>
  <li><b>عدم الحذف:</b> الحالات والإجراءات لا تُحذف نهائيًا؛ تُغلق أو تُلغى مع سبب (حماية للأثر).</li>
</ul>

<h4>11.4 سيناريوهات تفصيلية (Scenarios)</h4>
<h4>11.4.1 سيناريو: تسجيل مخالفة ثم اعتماد إجراء</h4>
<ol>
  <li><b>إنشاء الحالة:</b> discipline.record ينشئ DisciplineCase بحالة Draft.</li>
  <li><b>إرسال:</b> تحويل الحالة إلى Submitted.</li>
  <li><b>اعتماد:</b> حسب مسار المدرسة يتم اعتماد الحالة و/أو الإجراء.</li>
  <li><b>تنفيذ الإجراء:</b> إضافة DisciplineAction بحالة Planned ثم Done.</li>
  <li><b>إشعار ولي الأمر:</b> وفق السياسة (قد يكون بعد الاعتماد).</li>
</ol>

<h4>11.4.2 سيناريو: جلسة إرشاد مع متابعة</h4>
<ol>
  <li><b>فتح ملف الطالب:</b> المستخدم المخول يفتح تبويب الإرشاد.</li>
  <li><b>إضافة جلسة:</b> تسجيل الموضوع والملاحظات والتوصيات.</li>
  <li><b>إنشاء موعد متابعة:</b> (اختياري) عبر DisciplineAction أو حقل متابعة مستقل حسب التنفيذ.</li>
  <li><b>تقارير:</b> استخراج ملخص للمدير/الوكيل وفق الصلاحيات.</li>
</ol>

<h2>12) الكتب المدرسية (Textbooks) — تفصيلي</h2>
<ul>
  <li><b>المخزون:</b> إدخال الكتب بحسب (المادة/الصف/الفصل/الطبعة) وعدد النسخ.</li>
  <li><b>التسليم:</b> تسليم كتب للطالب مع تسجيل الحالة عند التسليم.</li>
  <li><b>الاسترجاع:</b> استرجاع الكتب وتسجيل الحالة عند الإرجاع.</li>
  <li><b>غرامات التلف/الفقد:</b> للمدارس الأهلية يمكن ربط الغرامة بحساب الطالب المالي.</li>
</ul>

<h4>12.1 نموذج البيانات (Data Model) — الكتب</h4>
<h4>12.1.1 عنصر كتاب بالمخزون (TextbookItem)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>bookItemId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>subjectId</td><td>GUID/INT</td><td>اختياري</td><td>المادة إن كان الكتاب مرتبطًا بمادة</td></tr>
    <tr><td>gradeLevel</td><td>Int</td><td>نعم</td><td>الصف</td></tr>
    <tr><td>title</td><td>String</td><td>نعم</td><td>اسم الكتاب</td></tr>
    <tr><td>edition</td><td>String</td><td>اختياري</td><td>الطبعة/السنة</td></tr>
    <tr><td>totalCopies</td><td>Int</td><td>نعم</td><td>عدد النسخ الكلي</td></tr>
    <tr><td>availableCopies</td><td>Int</td><td>نعم</td><td>عدد النسخ المتاحة</td></tr>
  </tbody>
</table>

<h4>12.1.2 عملية تسليم/استرجاع (TextbookTransaction)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>txId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>bookItemId</td><td>GUID/INT</td><td>نعم</td><td>الكتاب</td></tr>
    <tr><td>studentId</td><td>GUID/INT</td><td>نعم</td><td>الطالب</td></tr>
    <tr><td>txType</td><td>Enum</td><td>نعم</td><td>Issue/Return</td></tr>
    <tr><td>txDate</td><td>DateTime</td><td>نعم</td><td>وقت العملية</td></tr>
    <tr><td>condition</td><td>Enum/String</td><td>اختياري</td><td>Good/Damaged/Lost…</td></tr>
    <tr><td>fineAmount</td><td>Decimal</td><td>اختياري</td><td>غرامة (للأهلي) إن وجدت</td></tr>
    <tr><td>fineInvoiceId</td><td>GUID/INT</td><td>اختياري</td><td>ربط فاتورة غرامة إن فُعلت المالية</td></tr>
  </tbody>
</table>

<h4>12.2 الشاشات (UI Screens) — الكتب</h4>
<ul>
  <li><b>إدارة المخزون:</b> إضافة كتاب + تحديث عدد النسخ + تقارير النقص.</li>
  <li><b>تسليم كتب لشعبة:</b> اختيار شعبة ثم تسليم جماعي مع إنشاء معاملات Issue.</li>
  <li><b>استرجاع:</b> استرجاع فردي/جماعي مع تسجيل حالة الكتاب عند الإرجاع.</li>
  <li><b>غرامات:</b> عند تلف/فقد يمكن إنشاء غرامة وربطها بالمالية (للأهلي) إذا كانت السياسة مفعلة.</li>
</ul>

<h4>12.3 قواعد العمل (Business Rules) — الكتب</h4>
<ul>
  <li><b>عدم تجاوز المخزون:</b> لا يمكن تسليم أكثر من availableCopies.</li>
  <li><b>سياسة الغرامات:</b> قابلة للضبط (مبلغ ثابت/حسب نوع الضرر/حسب كتاب).</li>
  <li><b>الربط المالي:</b> الغرامات لا تُنشأ إلا إن كانت المدرسة أهلية أو فعّلت المالية.</li>
</ul>

<h4>12.4 سيناريوهات تفصيلية (Scenarios) — الكتب</h4>
<h4>12.4.1 سيناريو: تسليم كتب بداية الفصل</h4>
<ol>
  <li>تحديد الصف/الشعبة والكتب المطلوبة.</li>
  <li>التحقق من توفر النسخ.</li>
  <li>تنفيذ Issue لكل طالب وتحديث availableCopies.</li>
  <li>طباعة كشف تسليم.</li>
</ol>

<h4>12.4.2 سيناريو: استرجاع مع تلف/فقد</h4>
<ol>
  <li>استرجاع الكتاب وتحديد الحالة (Damaged/Lost).</li>
  <li>إنشاء غرامة حسب سياسة المدرسة (قد تتطلب اعتماد).</li>
  <li>للأهلي: إنشاء فاتورة غرامة وربطها بحساب الطالب.</li>
</ol>

<h2>13) الأصول والصيانة (Assets & Maintenance) — تفصيلي</h2>
<ul>
  <li><b>سجل الأصول:</b> إضافة أصل (اسم/نوع/رقم تسلسلي/موقع/مسؤول/تاريخ شراء/مورد/سعر).</li>
  <li><b>الصيانة:</b> فتح طلب صيانة، تحديد التكلفة، تغيير حالة الأصل (صالح/يحتاج صيانة/غير صالح).</li>
  <li><b>الترحيل:</b> نقل الأصل بين مرافق المدرسة مع حفظ التاريخ.</li>
  <li><b>الأثر المالي:</b> في المدارس الأهلية تُسجل التكلفة ضمن المصروفات أو تضاف إلى تكلفة الأصل حسب السياسة.</li>
</ul>

<h4>13.1 نموذج البيانات (Data Model) — الأصول</h4>
<h4>13.1.1 أصل (Asset)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>assetId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>name</td><td>String</td><td>نعم</td><td>اسم الأصل</td></tr>
    <tr><td>category</td><td>String/Enum</td><td>نعم</td><td>حاسوب/طابعة/أثاث…</td></tr>
    <tr><td>serialNumber</td><td>String</td><td>اختياري</td><td>رقم تسلسلي إن وجد</td></tr>
    <tr><td>location</td><td>String</td><td>نعم</td><td>الموقع داخل المدرسة</td></tr>
    <tr><td>responsibleUserId</td><td>GUID/INT</td><td>اختياري</td><td>المسؤول</td></tr>
    <tr><td>purchaseDate</td><td>Date</td><td>اختياري</td><td>تاريخ الشراء</td></tr>
    <tr><td>supplier</td><td>String</td><td>اختياري</td><td>المورد</td></tr>
    <tr><td>purchasePrice</td><td>Decimal</td><td>اختياري</td><td>السعر (للأهلي غالبًا)</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Good/NeedsMaintenance/OutOfService/Disposed</td></tr>
  </tbody>
</table>

<h4>13.1.2 طلب صيانة (MaintenanceRequest)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>requestId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>assetId</td><td>GUID/INT</td><td>نعم</td><td>الأصل</td></tr>
    <tr><td>issueDescription</td><td>String</td><td>نعم</td><td>وصف المشكلة</td></tr>
    <tr><td>priority</td><td>Enum</td><td>اختياري</td><td>Low/Medium/High</td></tr>
    <tr><td>estimatedCost</td><td>Decimal</td><td>اختياري</td><td>تكلفة تقديرية</td></tr>
    <tr><td>actualCost</td><td>Decimal</td><td>اختياري</td><td>تكلفة فعلية</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Draft/Submitted/Approved/InProgress/Done/Rejected</td></tr>
    <tr><td>approvedByUserId</td><td>GUID/INT</td><td>اختياري</td><td>اعتماد طلب الصيانة</td></tr>
    <tr><td>expenseVoucherId</td><td>GUID/INT</td><td>اختياري</td><td>ربط سند صرف/مصروف إن فُعلت المالية</td></tr>
  </tbody>
</table>

<h4>13.2 الشاشات (UI Screens) — الأصول</h4>
<ul>
  <li><b>سجل الأصول:</b> إضافة/تعديل أصل + البحث + طباعة بطاقة أصل.</li>
  <li><b>طلبات الصيانة:</b> فتح طلب، تقدير تكلفة، إرسال للاعتماد، متابعة التنفيذ.</li>
  <li><b>نقل أصل:</b> تغيير موقع الأصل مع حفظ سجل حركة.</li>
  <li><b>إخراج من الخدمة:</b> تحويل الحالة إلى OutOfService/Disposed مع سبب واعتماد.</li>
</ul>

<h4>13.3 قواعد العمل (Business Rules) — الأصول</h4>
<ul>
  <li><b>الأثر المالي:</b> في المدارس الأهلية يمكن ربط الصيانة بسند صرف؛ في الحكومي قد تكون فقط سجلًا إداريًا.</li>
  <li><b>الاعتماد:</b> طلبات الصيانة ذات تكلفة تتطلب اعتماد حسب سياسة المدرسة.</li>
  <li><b>تاريخ الحركة:</b> كل نقل/تعديل حالة يُسجل في التدقيق.</li>
</ul>

<h4>13.4 سيناريوهات تفصيلية (Scenarios) — الأصول</h4>
<h4>13.4.1 سيناريو: فتح طلب صيانة مع اعتماد وتسجيل تكلفة</h4>
<ol>
  <li>اختيار الأصل ووصف المشكلة وتقدير التكلفة.</li>
  <li>إرسال للاعتماد (إن طُبق).</li>
  <li>اعتماد الطلب ثم تغيير الحالة إلى InProgress.</li>
  <li>عند الإنجاز: إدخال التكلفة الفعلية وتحديث حالة الأصل.</li>
  <li>للأهلي (اختياري): إنشاء سند صرف وربطه بالطلب.</li>
</ol>

<h2>14) النظام المحاسبي (Accounting) — تفصيل وحداته</h2>
<p>المالية داخل المدرسة فقط ولا تُرسل للمكتب. تفعيلها يعتمد على نوع المدرسة (أهلي غالبًا) وعلى إعدادات المدرسة. جميع العمليات المالية تخضع لـ RBAC ومسارات اعتماد قابلة للتهيئة.</p>

<h4>14.1 نموذج بيانات أساسي (Core Finance Data Model)</h4>
<h4>14.1.1 دليل الحسابات (ChartOfAccounts)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>accountId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>code</td><td>String</td><td>نعم</td><td>كود الحساب</td></tr>
    <tr><td>name</td><td>String</td><td>نعم</td><td>اسم الحساب</td></tr>
    <tr><td>type</td><td>Enum</td><td>نعم</td><td>Asset/Liability/Equity/Revenue/Expense</td></tr>
    <tr><td>parentAccountId</td><td>GUID/INT</td><td>اختياري</td><td>شجرة الحسابات</td></tr>
    <tr><td>isActive</td><td>Boolean</td><td>نعم</td><td>تفعيل/تعطيل</td></tr>
  </tbody>
</table>

<h4>14.1.2 قيد يومية (JournalEntry)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف</th></tr>
  </thead>
  <tbody>
    <tr><td>jeId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>jeDate</td><td>Date</td><td>نعم</td><td>تاريخ القيد</td></tr>
    <tr><td>description</td><td>String</td><td>نعم</td><td>وصف القيد</td></tr>
    <tr><td>status</td><td>Enum</td><td>نعم</td><td>Draft/Posted/Cancelled</td></tr>
    <tr><td>createdByUserId</td><td>GUID/INT</td><td>نعم</td><td>من أنشأ</td></tr>
    <tr><td>postedByUserId</td><td>GUID/INT</td><td>اختياري</td><td>من رحّل</td></tr>
  </tbody>
</table>

<h4>14.1.3 بنود القيد (JournalEntryLine)</h4>
<table>
  <thead>
    <tr><th>الحقل</th><th>النوع</th><th>إلزامي</th><th>الوصف/قواعد</th></tr>
  </thead>
  <tbody>
    <tr><td>lineId</td><td>GUID/INT</td><td>نعم</td><td>مفتاح داخلي</td></tr>
    <tr><td>jeId</td><td>GUID/INT</td><td>نعم</td><td>مرجع القيد</td></tr>
    <tr><td>accountId</td><td>GUID/INT</td><td>نعم</td><td>الحساب</td></tr>
    <tr><td>debit</td><td>Decimal</td><td>اختياري</td><td>مدين</td></tr>
    <tr><td>credit</td><td>Decimal</td><td>اختياري</td><td>دائن</td></tr>
    <tr><td>memo</td><td>String</td><td>اختياري</td><td>ملاحظة</td></tr>
  </tbody>
</table>

<h3>14.2 دفتر الأستاذ العام (GL)</h3>
<ul>
  <li>تعريف دليل الحسابات، القيود اليومية، الترحيل، الإقفال الشهري.</li>
  <li>سندات قبض/صرف تُرحّل إلى GL وفق ربط حسابي مسبق.</li>
</ul>

<h4>14.2.1 قواعد العمل الأساسية (GL Rules)</h4>
<ul>
  <li><b>اتزان القيد:</b> مجموع المدين = مجموع الدائن قبل السماح بالترحيل.</li>
  <li><b>الإقفال الشهري:</b> بعد الإقفال لا تُقبل قيود بتاريخ الشهر إلا بصلاحية استثنائية/مسار اعتماد.</li>
  <li><b>فصل الواجبات (اختياري):</b> يمكن منع أن يكون المنشئ هو المرحِّل.</li>
</ul>

<h4>14.2.2 سيناريو: قيد يومية وترحيل</h4>
<ol>
  <li>إنشاء قيد Draft وإضافة البنود.</li>
  <li>التحقق من الاتزان.</li>
  <li>اعتماد/ترحيل (Posted) حسب سياسة المدرسة.</li>
</ol>

<h3>14.3 الرسوم الدراسية (Student Fees / AR)</h3>
<ul>
  <li>تعريف بنود الرسوم (تسجيل/فصلية/سنوية/مواصلات/كتب/أنشطة).</li>
  <li>إنشاء فواتير/مستحقات على الطالب أو على مجموعة (صف/شعبة).</li>
  <li>خصومات وإعفاءات مع اعتماد إداري وسجل تدقيق.</li>
  <li>تحصيل: نقد/تحويل/بوابة دفع (لاحقًا) مع إيصال إلكتروني.</li>
</ul>

<h4>14.3.1 نموذج بيانات الرسوم والتحصيل</h4>
<table>
  <thead>
    <tr><th>الكيان</th><th>حقول أساسية</th><th>ملاحظات</th></tr>
  </thead>
  <tbody>
    <tr><td>FeeDefinition</td><td>الاسم، الصف/المرحلة، المبلغ، التكرار (فصل/سنة/قسط)، تاريخ الاستحقاق</td><td>قابل للتفعيل/التعطيل</td></tr>
    <tr><td>StudentInvoice</td><td>الطالب، الفترة، الإجمالي، الخصم، الصافي، الحالة (Draft/Issued/Paid/Partial/Cancelled)</td><td>يمكن توليده جماعيًا</td></tr>
    <tr><td>Receipt</td><td>رقم الإيصال، تاريخ، طريقة دفع، مبلغ، مرجع فاتورة</td><td>يرحّل للـ GL إذا فُعل الربط</td></tr>
    <tr><td>Discount/Exemption</td><td>النوع، النسبة/المبلغ، السبب، المعتمد</td><td>غالبًا يتطلب اعتماد</td></tr>
  </tbody>
</table>

<h4>14.3.2 سيناريو: تعريف رسوم ثم توليد مستحقات ثم تحصيل</h4>
<ol>
  <li>تعريف FeeDefinition لصف/مرحلة.</li>
  <li>توليد فواتير للطلاب (صف/شعبة) للفصل/الأقساط.</li>
  <li>تطبيق خصومات/إعفاءات مع اعتماد.</li>
  <li>تحصيل وإصدار إيصال وتحديث حالة الفاتورة.</li>
  <li>(اختياري) ترحيل القيد للـ GL.</li>
</ol>

<h3>14.4 المصروفات والمشتريات (AP / Expenses)</h3>
<ul>
  <li>مصروفات تشغيلية: تعريف بنود مصروف، سند صرف، ربط بحسابات GL.</li>
  <li>مشتريات: طلب شراء → اعتماد → أمر شراء → استلام → فاتورة → دفع (إن رغبت المدرسة بتفعيل الدورة الكاملة).</li>
</ul>

<h4>14.4.1 سيناريو: مصروف مباشر (سند صرف)</h4>
<ol>
  <li>إنشاء سند صرف Draft مع بند المصروف والمبلغ وطريقة الدفع.</li>
  <li>إرسال للاعتماد (إن طُبق) ثم اعتماد.</li>
  <li>صرف وتحديث الحالة.</li>
  <li>(اختياري) إنشاء قيد يومية وترحيله.</li>
</ol>

<h4>14.4.2 سيناريو: دورة مشتريات كاملة</h4>
<ol>
  <li>طلب شراء (Request) مع الكميات والمواصفات.</li>
  <li>اعتماد الطلب.</li>
  <li>أمر شراء (PO) للمورد.</li>
  <li>استلام (GRN) وتسجيل الفاتورة.</li>
  <li>دفع وربطها بـ GL.</li>
</ol>

<h3>14.5 الرواتب (Payroll) للمدارس الأهلية</h3>
<ul>
  <li>تعريف عقد/راتب أساسي + بدلات + خصومات + سلف.</li>
  <li>احتساب الغياب/التأخير من نظام حضور المعلمين (إن تم تفعيل الربط).</li>
  <li>مسير رواتب شهري واعتماد وصرف، وإتاحة قسيمة راتب للمعلم.</li>
</ul>

<h4>14.5.1 نموذج بيانات الرواتب</h4>
<table>
  <thead>
    <tr><th>الكيان</th><th>حقول أساسية</th><th>ملاحظات</th></tr>
  </thead>
  <tbody>
    <tr><td>EmployeeContract</td><td>المعلم/الموظف، الراتب الأساسي، البدلات، الخصومات الثابتة، تاريخ السريان</td><td>قد يتغير بإصدار عقد جديد</td></tr>
    <tr><td>PayrollRun</td><td>الشهر، الحالة (Draft/Approved/Paid)، الإجمالي، المعتمد</td><td>يربط بسندات صرف/قيود</td></tr>
    <tr><td>Payslip</td><td>الموظف، الاستحقاقات، الخصومات، الصافي</td><td>عرض للموظف حسب الصلاحيات</td></tr>
  </tbody>
</table>

<h4>14.5.2 سيناريو: مسير رواتب (تجميع حضور → اعتماد → صرف)</h4>
<ol>
  <li>تجميع حضور/تأخير الشهر (إن كان الربط مفعلًا).</li>
  <li>حساب الاستحقاقات والخصومات لكل موظف.</li>
  <li>إنشاء PayrollRun Draft ثم اعتماد.</li>
  <li>صرف الرواتب (كدفعة/سندات) وأرشفة العملية.</li>
</ol>

<h3>14.6 التقارير المالية داخل المدرسة</h3>
<ul>
  <li>إيرادات الرسوم حسب الفترة وبحسب نوع الرسوم.</li>
  <li>المتأخرات حسب طالب/صف.</li>
  <li>المصروفات حسب البند.</li>
  <li>الرواتب الشهرية.</li>
  <li>ملخص دخل/مصروف (حسب الفترة).</li>
</ul>

<h2>15) سيناريو التهيئة الأولية للمدرسة (Initial Setup Wizard)</h2>
<p>الغرض من هذا السيناريو هو الوصول إلى نقطة “نظام جاهز للتشغيل” بعد تثبيت نسخة المدرسة، بغض النظر عن كونها حكومية أو أهلية. التهيئة تتم مرة واحدة كبداية، ثم تُدار التغييرات لاحقًا عبر الصلاحيات ومسارات الاعتماد.</p>

<h3>15.1 مرحلة 1: تعريف المدرسة وتحديد النوع (حكومي/أهلي)</h3>
<ol>
  <li><b>إدخال ملف المدرسة:</b> الاسم، الموقع، الرقم، بيانات التواصل، المراحل الدراسية المتاحة.</li>
  <li><b>اختيار نوع المدرسة:</b> حكومي أو أهلي.</li>
  <li><b>تطبيق سياسات افتراضية حسب النوع:</b>
    <ul>
      <li><b>حكومي:</b> تعطيل الرسوم افتراضيًا، تقييد المالية على تقارير داخلية فقط إن فُعلت، سياسات تقييم أقرب للوائح المكتب/الوزارة.</li>
      <li><b>أهلي:</b> تفعيل الرسوم افتراضيًا، تفعيل أدوات التحصيل/الخصومات/الإعفاءات، تمكين الرواتب/المصروفات حسب الحاجة.</li>
    </ul>
  </li>
  <li><b>تعريف الهيكل الزمني:</b> فترات العمل (صباح/مساء/فترتين) + أيام الدوام + مخطط اليوم الدراسي (عدد الحصص ومدة كل حصة).</li>
  <li><b>تعريف السنة الدراسية الحالية:</b> تاريخ البداية والنهاية، الفصول (ترم 1/2) وتقسيم الأشهر إن لزم.</li>
</ol>

<h3>15.2 مرحلة 2: تأسيس المستخدمين والأدوار والصلاحيات (من الصفر)</h3>
<ol>
  <li><b>تسجيل الدخول بحساب التأسيس:</b> School System Admin (لا يستخدم للتشغيل اليومي).</li>
  <li><b>إنشاء الأقسام/الوحدات:</b> وفق تنظيم المدرسة (اختياري، لكنه يُسهّل التعيينات لاحقًا).</li>
  <li><b>إنشاء المسميات الوظيفية:</b> حسب مسميات المدرسة الفعلية (اختياري).</li>
  <li><b>إنشاء الأدوار من الصفر:</b> المدرسة تُنشئ Roles خاصة بها فقط (لا يوجد افتراض أدوار ثابتة).</li>
  <li><b>اختيار الصلاحيات لكل دور:</b> من كتالوج الصلاحيات (5.1.3.1) + تحديد النطاق (Own/Any/AfterClose).</li>
  <li><b>إعداد مسارات الاعتماد:</b> تعريف من يعتمد العمليات الحساسة (مثل فتح إقفال، اعتماد إرسال نتائج، اعتماد صرف…).</li>
  <li><b>إنشاء المستخدمين التشغيليين:</b> مدير/وكيل/شؤون طلاب/معلمين/محاسب… حسب ما تريد المدرسة.</li>
  <li><b>إسناد الأدوار للمستخدمين:</b> كل مستخدم قد يحمل أكثر من دور حسب الواقع.</li>
</ol>

<h3>15.3 مرحلة 3: تأسيس البيانات الأكاديمية (الصفوف/الشُعب/المواد)</h3>
<ol>
  <li><b>تعريف الصفوف الدراسية:</b> (1–6) ابتدائي، (7–9) إعدادي، (أول/ثاني/ثالث) ثانوي حسب المرحلة المفعلة.</li>
  <li><b>تعريف الشُعب:</b> لكل صف (أ، ب، ج…) وربطها بفترة عمل إن وجدت.</li>
  <li><b>تعريف المواد وخططها:</b> المواد لكل صف + توزيع التقييم (شهري/نصفي/نهائي) حسب سياسة المدرسة.</li>
  <li><b>إدخال المعلمين:</b> ملفات المعلمين وبياناتهم.</li>
</ol>

<h3>15.4 مرحلة 4: إعداد الجدول وربط نطاق المعلم (Own) بجدول الحصص</h3>
<ol>
  <li><b>تعريف القاعات/المعامل:</b> (اختياري) لتحسين الجدولة.</li>
  <li><b>إنشاء جدول حصصي:</b> تحديد حصص الأسبوع لكل شعبة وتوزيعها على المعلمين.</li>
  <li><b>اعتماد الجدول:</b> نشر إصدار جدول “معتمد” (Baseline).</li>
  <li><b>نطاق المعلم (Own):</b> يصبح مرتبطًا بحصصه في الجدول المعتمد فقط؛ أي حضور/درجات يستطيع إدخالها فقط للحصص المُسندة له.</li>
  <li><b>بدء التشغيل:</b> بعد اعتماد الجدول تصبح عمليات التحضير الحصصي وإدخال الدرجات متاحة وفق الصلاحيات.</li>
</ol>

<h3>15.5 مرحلة 5: (للأهلي) تأسيس المالية الأساسية قبل التشغيل</h3>
<ol>
  <li><b>تعريف الرسوم:</b> رسوم الصفوف، رسوم الأنشطة، الخصومات، الإعفاءات.</li>
  <li><b>سياسة التعثر:</b> ما الذي يُمنع (شهادة/نتيجة/نقل) عند وجود متأخرات (اختياري حسب سياسة المدرسة).</li>
  <li><b>تهيئة طرق التحصيل:</b> نقدي/تحويل/شبكة (بحسب ما تدعمه المدرسة).</li>
</ol>

<h3>15.6 سيناريوهات تشغيل تفصيلية (Operational Scenarios) — أمثلة أساسية</h3>
<p>السيناريوهات التالية تُطبق نفس الفكرة: <b>من ينفذ</b> يتحدد عبر RBAC، و<b>من يعتمد</b> يتحدد عبر Workflow الخاص بالمدرسة.</p>

<h3>15.6.1 سيناريو: إنشاء طالب جديد وتسكينه</h3>
<ol>
  <li><b>إدخال البيانات:</b> مستخدم لديه صلاحية students.create يقوم بإنشاء سجل الطالب.</li>
  <li><b>الوثائق:</b> رفع الوثائق (students.documents.manage) إن لزم.</li>
  <li><b>التسكين:</b> اختيار الصف/الشعبة/الفترة (students.assign.class).</li>
  <li><b>اعتماد العملية:</b> إذا كانت المدرسة تطبق مسار اعتماد (مثلاً شؤون الطلاب → مدير)، تتحول الحالة إلى “بانتظار اعتماد”.</li>
  <li><b>الإقفال/الحفظ:</b> بعد الاعتماد تصبح حالة الطالب “فعال” ويظهر في كشوف الشعبة.</li>
</ol>

<h3>15.6.2 سيناريو: التحضير الحصصي اليومي حسب جدول الحصص</h3>
<ol>
  <li><b>تحميل الحصص:</b> النظام يعرض للمعلم حصص اليوم من الجدول المعتمد فقط.</li>
  <li><b>تسجيل الحضور:</b> المعلم يسجل حضور الطلاب في حصته (attendance.students.record) ضمن نطاق Own.</li>
  <li><b>الإغلاق:</b> عند نهاية اليوم/الفترة (حسب سياسة المدرسة) يتم إغلاق التحضير.</li>
  <li><b>تصحيح بعد الإغلاق:</b> يتطلب صلاحية AfterClose أو مسار اعتماد حسب إعداد المدرسة.</li>
</ol>

<h3>15.6.3 سيناريو: إدخال درجات ثم إقفال/فتح إقفال</h3>
<ol>
  <li><b>إدخال الدرجات:</b> المعلم يدخل درجات حصصه فقط (grades.enter ضمن Own حسب الجدول).</li>
  <li><b>تدقيق آلي:</b> النظام يتحقق من حدود الدرجات والحقول الإلزامية.</li>
  <li><b>إقفال الشهر/الفصل:</b> مستخدم مخول (grades.close.month/grades.close.term) يُقفل الفترة.</li>
  <li><b>فتح الإقفال:</b> لا يتم إلا بصلاحية (grades.open.month) وغالبًا عبر مسار اعتماد مخصص للمدرسة.</li>
  <li><b>سجل تدقيق:</b> أي تعديل على الدرجات خصوصًا بعد الإقفال يسجل (من/متى/ما الذي تغير).</li>
</ol>

<h3>15.6.4 سيناريو: إعداد تقرير النتائج وإرساله لمكتب التربية</h3>
<ol>
  <li><b>توليد التقرير:</b> reports.generate يقوم بتجهيز حزمة التقرير المطلوبة (ترم/سنة) وفق مخطط Report Packages.</li>
  <li><b>اعتماد التقرير:</b> reports.approve ثم اعتماد مدير المدرسة حسب مسار الاعتماد.</li>
  <li><b>الإرسال:</b> office.submit.results مع التحقق من عدم وجود بيانات مالية ضمن الحزمة.</li>
  <li><b>الاستجابة:</b> قبول/رفض من المكتب مع سبب؛ عند الرفض يتم تصحيح ثم إعادة إرسال.</li>
</ol>

<h2>16) القواعد والضوابط (Business Rules) — تفصيلي</h2>

<h3>16.1 قواعد عامة للبيانات والهوية</h3>
<ul>
  <li><b>حالة دراسية واحدة:</b> لا يجوز للطالب أن يكون (مستمر) و(منقول/منقطع/موقوف) في نفس الوقت.</li>
  <li><b>هوية داخل المدرسة:</b> الرقم المدرسي فريد داخل المدرسة، ولا يعاد استخدامه إلا بسياسة واضحة (مع سجل يوضح سبب إعادة الاستخدام إن حدث).</li>
  <li><b>قيود العمر:</b> منع تسجيل طالب في الصف الأول دون حد عمر قابل للضبط من إعدادات المدرسة.</li>
  <li><b>عدم الحذف النهائي للكيانات الحساسة:</b> (طالب/قيد/حضور/درجات/قيود مالية/سلوك) يُستخدم إلغاء/إقفال/إخفاء منطقي مع سبب.</li>
</ul>

<h3>16.2 قواعد الصلاحيات والنطاق (RBAC & Scope)</h3>
<ul>
  <li><b>لا توجد أدوار ثابتة:</b> المدرسة تبني الأدوار من الصفر، وتُحدد من ينفذ ومن يعتمد ومن يطّلع.</li>
  <li><b>Own للمعلم:</b> يُشتق تلقائيًا من <b>الجدول المعتمد/المنشور</b> فقط (حصصه فقط) للحضور والدرجات والتحضير.</li>
  <li><b>فصل الواجبات:</b> يمكن للمدرسة فرض أن منشئ المعاملة لا يعتمدها (خصوصًا في المالية/التعديلات الاستثنائية).</li>
  <li><b>سجلات الحساسية:</b> الإرشاد والصحة لها صلاحيات عرض/تعديل منفصلة عن “شؤون الطلاب” وعن “الإدارة”.</li>
</ul>

<h3>16.3 قواعد الاعتماد ومسارات العمل (Workflow Rules)</h3>
<ul>
  <li><b>المسارات ديناميكية:</b> كل عملية حساسة يمكن ربطها بمسار اعتماد من إعدادات المدرسة (عدد مراحل/أدوار/مهل/تصعيد).</li>
  <li><b>أثر الاعتماد:</b> لا ينتقل الكيان من Draft إلى Approved/Published إلا بعد اكتمال المسار.</li>
  <li><b>الرفض والإعادة:</b> أي رفض يجب أن يتضمن سبب، مع إمكانية الإعادة للتعديل وإعادة الإرسال.</li>
  <li><b>التفويض:</b> التفويض مُؤقت بزمن وسبب، ويُسجل في التدقيق.</li>
</ul>

<h3>16.4 قواعد التدقيق والأثر (Audit & Traceability)</h3>
<ul>
  <li><b>تسجيل الأثر:</b> كل عملية إنشاء/تعديل/اعتماد/إقفال/فتح إقفال تُسجل (من، متى، من أين، ما الذي تغيّر، ولماذا).</li>
  <li><b>سبب إلزامي للتعديلات الحساسة:</b> تعديل بعد الإقفال في الدرجات/المالية/السلوك يتطلب reason إلزامي.</li>
  <li><b>الإشعارات:</b> الإشعارات (ولي أمر/معلم/إدارة) تُسجل كأحداث (Events) لضمان تتبعها.</li>
</ul>

<h3>16.5 قواعد الجدول والحضور</h3>
<ul>
  <li><b>الجدول بالإصدارات:</b> لا يوجد “تعديل مباشر” على جدول منشور؛ يتم إنشاء نسخة (Version) ثم اعتماد/نشر.</li>
  <li><b>الحضور مرتبط بجلسة:</b> لا يُسمح بتحضير حصة/يوم بدون وجود AttendanceSession صالحة.</li>
  <li><b>التعديل الزمني:</b> فتح نافذة تعديل الحضور (إن وجدت) محكومة بسياسة المدرسة وصلاحية استثنائية.</li>
</ul>

<h3>16.6 قواعد الدرجات والتقييم</h3>
<ul>
  <li><b>مخطط تقييم:</b> أي مادة/صف يجب أن يرتبط بمخطط تقييم (AssessmentSchema) يحدد البنود والحدود.</li>
  <li><b>الإقفال:</b> بعد إقفال الشهر/الفصل لا تعديل إلا بصلاحية استثنائية أو فتح إقفال مؤقت مع تدقيق كامل.</li>
  <li><b>تاريخ التغييرات:</b> كل تغيير درجة يُنشئ GradeChangeLog مع قبل/بعد وسبب.</li>
</ul>

<h3>16.7 قواعد السلوك/الإرشاد/الصحة</h3>
<ul>
  <li><b>خصوصية عالية:</b> الصحة والإرشاد مخفية افتراضيًا ولا تُعرض إلا لصلاحيات محددة.</li>
  <li><b>عدم الحذف:</b> قضايا السلوك تُغلق/تُلغى ولا تُحذف نهائيًا.</li>
  <li><b>سياسة الإشعار:</b> إشعار ولي الأمر مرتبط بسياسة المدرسة (فوري/بعد اعتماد/حسب التصنيف).</li>
</ul>

<h3>16.8 قواعد الكتب</h3>
<ul>
  <li><b>رصيد المخزون:</b> لا تسليم دون توفر (availableCopies) كافٍ.</li>
  <li><b>تتبع الحالة:</b> حالة الكتاب عند التسليم/الإرجاع تُسجل وتؤثر على الغرامات إن فُعلت.</li>
  <li><b>الغرامات:</b> لا تُنشأ ماليًا إلا في المدارس الأهلية أو إذا فُعلت المالية في المدرسة.</li>
</ul>

<h3>16.9 قواعد الأصول والصيانة</h3>
<ul>
  <li><b>حركة الأصل:</b> أي نقل موقع/تغيير مسؤول/تغيير حالة يجب أن يُسجل.</li>
  <li><b>الصيانة بتسلسل:</b> Draft → Submitted → Approved → InProgress → Done مع صلاحيات منفصلة لكل خطوة.</li>
  <li><b>الأثر المالي اختياري:</b> في الأهلي يمكن الربط بسند صرف؛ في الحكومي قد تبقى إدارية فقط.</li>
</ul>

<h3>16.10 قواعد المالية (داخل المدرسة فقط)</h3>
<ul>
  <li><b>عدم إرسال مالية للمكتب:</b> لا يتم تضمين أي قيود/إيصالات/رواتب ضمن حزم التقارير المرسلة لمكتب التربية.</li>
  <li><b>اتزان القيود:</b> لا ترحيل لقيد غير متزن (مدين=دائن).</li>
  <li><b>إقفال شهري:</b> بعد الإقفال لا إدخالات بتاريخ الشهر إلا باستثناء وتدقيق.</li>
  <li><b>سياسة المتأخرات:</b> لا تمنع حضور الطالب للحصص بسبب التعثر المالي، ويمكن تقييد الشهادات/النقل الرسمي حسب سياسة المدرسة.</li>
</ul>

<h2>17) سير العمل (Workflows) — خطوات تنفيذية</h2>
<h3>17.1 تسجيل طالب جديد</h3>

<h4>17.1.0 مدخلات وشروط</h4>
<ul>
  <li><b>الصلاحيات:</b> students.request.create لإنشاء الطلب، students.request.review للمراجعة، students.approve للاعتماد النهائي.</li>
  <li><b>البيانات المطلوبة:</b> بيانات الطالب + ولي الأمر + وثائق أساسية حسب سياسة المدرسة.</li>
  <li><b>المخرجات:</b> Student + Enrollment + رقم مدرسي + سجل تدقيق + (اختياري) إشعار ولي الأمر.</li>
</ul>

<h4>17.1.1 خطوات التنفيذ</h4>
<ol>
  <li><b>إنشاء طلب تسجيل:</b> إدخال بيانات الطالب وولي الأمر وإرفاق الوثائق ثم حفظ Draft.</li>
  <li><b>تحديد النقل (اختياري):</b> اختيار طريقة النقل. إذا تم اختيار Bus (للأهلي) يتم اختيار الباص/المسار/نقطة التجمع وإنشاء StudentTransportPreference + StudentBusAssignment وفق صلاحية transport.manage أو صلاحية الطلاب المعتمدة.</li>
  <li><b>إرسال للمراجعة:</b> تحويل الطلب إلى Submitted وتحديد “جهة المراجعة” حسب تنظيم المدرسة.</li>
  <li><b>مراجعة شؤون الطلاب:</b> التحقق من اكتمال البيانات والوثائق؛ إن نقص شيء تُعاد للمنشئ مع سبب.</li>
  <li><b>الاعتماد:</b> تنفيذ مسار اعتماد المدرسة (قد يكون مرحلة واحدة أو عدة مراحل).</li>
  <li><b>إنشاء الرقم المدرسي:</b> عند الاعتماد النهائي يتم توليد الرقم المدرسي وتفعيل Student.</li>
  <li><b>التسكين:</b> إنشاء Enrollment للعام/الفصل وربط الصف/الشعبة/الفترة وتحديد حالة الطالب (مستمر).</li>
  <li><b>إسناد المواد:</b> ربط الطالب بخطة المواد حسب الصف/الشعبة إن كانت مفعلة.</li>
  <li><b>الإشعارات:</b> إشعار ولي الأمر بقبول التسجيل (حسب سياسة المدرسة).</li>
</ol>

<h4>17.1.2 حالات استثنائية</h4>
<ul>
  <li><b>رفض الطلب:</b> status=Rejected مع سبب وتاريخ.</li>
  <li><b>تكرار طالب:</b> منع إنشاء طالب جديد إذا كانت الهوية/الرقم الوطني موجودة حسب سياسة المدرسة.</li>
</ul>

<h3>17.2 الحضور اليومي/الحصصي</h3>

<h4>17.2.0 مدخلات وشروط</h4>
<ul>
  <li><b>الصلاحيات:</b> attendance.take (Own للمعلم حسب الجدول)، attendance.review للإدارة، attendance.edit.afterClose للاستثناءات.</li>
  <li><b>شرط الجدول:</b> لا تحضير حصصي بدون TimetableVersion منشور + TimetableSlot مرتبط بالمعلم.</li>
  <li><b>المخرجات:</b> AttendanceSession + StudentAttendanceRecord + إشعارات (اختياري).</li>
</ul>

<h4>17.2.1 خطوات التنفيذ (تحضير حصصي)</h4>
<ol>
  <li><b>تحديد الحصة:</b> النظام يعرض للمعلم حصصه فقط لليوم من الجدول المنشور.</li>
  <li><b>فتح جلسة:</b> إنشاء/استرجاع AttendanceSession لتلك الحصة.</li>
  <li><b>تسجيل الحالات:</b> تعيين الحالة لكل طالب (حاضر/غائب/متأخر/مستأذن) مع ملاحظات إن لزم.</li>
  <li><b>إضافة عذر:</b> إن كان هناك عذر، يتم إنشاء AttendanceExcuse ويرتبط بالسجل.</li>
  <li><b>تثبيت التحضير:</b> تحويل الجلسة إلى Locked/Submitted حسب سياسة المدرسة.</li>
  <li><b>الإشعارات:</b> إرسال إشعار لولي الأمر عند الغياب/التأخر حسب إعدادات المدرسة.</li>
</ol>

<h4>17.2.2 مراجعة الإدارة وتصحيح</h4>
<ol>
  <li><b>تدقيق يومي:</b> الإدارة تراجع غياب اليوم وتقاطع مع الأعذار.</li>
  <li><b>تصحيح:</b> تعديل بحدود الصلاحيات والزمن؛ إن كان بعد الإقفال يتطلب reason وتسجيل تدقيق.</li>
</ol>

<h3>17.3 إدخال الدرجات والإقفال</h3>

<h4>17.3.0 مدخلات وشروط</h4>
<ul>
  <li><b>الصلاحيات:</b> grades.enter (Own حسب الجدول)، grades.review، grades.approve، grades.close.month، grades.open.month، grades.edit.afterClose.</li>
  <li><b>شرط المخطط:</b> لا إدخال درجات بدون AssessmentSchema فعّال للمادة/الصف/الفصل.</li>
  <li><b>المخرجات:</b> Gradebook + StudentGradeEntry + GradeChangeLog + حالة إقفال.</li>
</ul>

<h4>17.3.1 إدخال درجات شهرية</h4>
<ol>
  <li><b>اختيار:</b> المادة + الصف/الشعبة + الشهر/الفترة.</li>
  <li><b>تحميل كشف الطلاب:</b> حسب Enrollment النشط.</li>
  <li><b>إدخال:</b> إدخال جماعي/فردي، والتحقق من الحدود (0..Max) ومن نوع البند.</li>
  <li><b>حفظ:</b> حفظ مسودة أو إرسال للمراجعة حسب سياسة المدرسة.</li>
  <li><b>مراجعة/اعتماد:</b> تنفيذ مسار اعتماد المدرسة إن كان مفعلًا.</li>
  <li><b>إقفال الشهر:</b> تنفيذ grades.close.month لمنع التعديل.</li>
</ol>

<h4>17.3.2 إدخال نصفي/نهائي وإقفال الفصل</h4>
<ol>
  <li><b>إدخال النصفي/النهائي:</b> وفق مخطط التقييم.</li>
  <li><b>احتساب المجاميع:</b> النظام يحتسب المجموع ويظهر حالات التعارض/النقص.</li>
  <li><b>إقفال الفصل:</b> تحويل الفصل إلى Closed بعد اعتماد نهائي حسب السياسة.</li>
</ol>

<h4>17.3.3 تعديل بعد الإقفال (استثنائي)</h4>
<ol>
  <li><b>فتح نافذة:</b> grades.open.month لمدة محددة أو صلاحية مباشرة grades.edit.afterClose.</li>
  <li><b>إلزام السبب:</b> reason + تسجيل GradeChangeLog.</li>
  <li><b>إعادة الإقفال:</b> بعد الانتهاء.</li>
</ol>

<h3>17.4 الرسوم والتحصيل (للأهلي)</h3>

<h4>17.4.0 مدخلات وشروط</h4>
<ul>
  <li><b>الصلاحيات:</b> fees.define، fees.invoice.generate، fees.discount.request/approve، fees.collect، gl.post (إن فُعل الربط).</li>
  <li><b>المخرجات:</b> FeeDefinition + StudentInvoice + Receipt + (اختياري) JournalEntry.</li>
</ul>

<h4>17.4.1 خطوات التنفيذ</h4>
<ol>
  <li><b>تعريف بنود الرسوم:</b> إنشاء FeeDefinition وربطه بالصف/المرحلة والفترة.</li>
  <li><b>توليد المستحقات:</b> إنشاء فواتير للطلاب (طلاب محددين/صف/شعبة) مع تواريخ استحقاق.</li>
  <li><b>الخصومات والإعفاءات:</b> إدخال طلب خصم/إعفاء ثم مسار اعتماد المدرسة.</li>
  <li><b>التحصيل:</b> إنشاء Receipt وتحديث حالة الفاتورة (Paid/Partial) وطباعة/إرسال إيصال.</li>
  <li><b>الترحيل للـ GL:</b> (اختياري) إنشاء قيد وترحيله وفق ربط حسابي مُسبق.</li>
</ol>

<h4>17.4.2 حالات استثنائية</h4>
<ul>
  <li><b>إلغاء إيصال:</b> لا حذف؛ يتم إلغاء مع سبب وإشعار المدقق وربط بقيد عكسي إن وُجد.</li>
</ul>

<h3>17.5 الرواتب (للأهلي)</h3>

<h4>17.5.0 مدخلات وشروط</h4>
<ul>
  <li><b>الصلاحيات:</b> payroll.contract.manage، payroll.run.create، payroll.run.approve، payroll.pay، gl.post (إن فُعل الربط).</li>
  <li><b>المخرجات:</b> EmployeeContract + PayrollRun + Payslip + (اختياري) قيود/سندات.</li>
</ul>

<h4>17.5.1 خطوات التنفيذ</h4>
<ol>
  <li><b>تحديث العقود:</b> التأكد من وجود EmployeeContract فعال لكل موظف.</li>
  <li><b>تجميع الحضور:</b> (اختياري) ربط التأخير/الغياب من Attendance للموظفين.</li>
  <li><b>حساب المسير:</b> احتساب الاستحقاقات والخصومات وإنشاء PayrollRun Draft.</li>
  <li><b>اعتماد المسير:</b> تنفيذ مسار اعتماد المدرسة.</li>
  <li><b>الصرف:</b> إنشاء عملية دفع وتثبيت PayrollRun كـ Paid وإتاحة قسائم الرواتب للموظفين حسب الصلاحيات.</li>
  <li><b>الترحيل:</b> (اختياري) إنشاء قيد وترحيله.</li>
</ol>

<h3>17.6 السلوك (تسجيل واقعة → اعتماد → إشعار → إغلاق)</h3>
<ol>
  <li><b>إنشاء:</b> discipline.record ينشئ DisciplineCase Draft.</li>
  <li><b>إرسال:</b> Submitted.</li>
  <li><b>اعتماد:</b> حسب المسار، Approved.</li>
  <li><b>إجراء:</b> إنشاء DisciplineAction (قد يتطلب اعتماد).</li>
  <li><b>إشعار ولي الأمر:</b> حسب سياسة المدرسة.</li>
  <li><b>إغلاق:</b> Closed عند اكتمال المتابعة.</li>
</ol>

<h3>17.7 الكتب (تسليم/استرجاع/غرامة)</h3>
<ol>
  <li><b>إعداد المخزون:</b> إضافة/تحديث TextbookItem.</li>
  <li><b>تسليم:</b> Issue لكل طالب وتخفيض availableCopies.</li>
  <li><b>استرجاع:</b> Return وتسجيل الحالة (Good/Damaged/Lost).</li>
  <li><b>غرامة:</b> (اختياري) إنشاء غرامة وربطها بالمالية للأهلي وفق السياسة.</li>
</ol>

<h3>17.8 الأصول والصيانة (طلب → اعتماد → تنفيذ → تكلفة)</h3>
<ol>
  <li><b>فتح طلب:</b> MaintenanceRequest Draft مع تقدير تكلفة.</li>
  <li><b>اعتماد:</b> Submitted → Approved حسب المسار.</li>
  <li><b>تنفيذ:</b> InProgress ثم Done مع تكلفة فعلية.</li>
  <li><b>أثر مالي:</b> (اختياري) سند صرف/قيد للأهلي.</li>
</ol>

<h2>18) المخرجات والتقارير (Reports) — تفصيل</h2>
<h3>18.1 تقارير أكاديمية</h3>

<h4>18.1.1 كشف درجات طالب</h4>
<ul>
  <li><b>فلاتر:</b> طالب، عام، فصل، عرض بنود التقييم.</li>
  <li><b>أعمدة:</b> المادة، الشهر/النصفي/النهائي، المجموع، ملاحظات.</li>
  <li><b>الصلاحيات:</b> grades.view (Own للمعلم على حصصه، Full للإدارة حسب الدور).</li>
  <li><b>مخرجات:</b> شاشة + PDF + Excel.</li>
</ul>

<h4>18.1.2 كشف درجات صف/شعبة/مادة</h4>
<ul>
  <li><b>فلاتر:</b> صف، شعبة، مادة، فترة.</li>
  <li><b>الصلاحيات:</b> grades.view.class / grades.view (حسب تصميم كتالوج المدرسة).</li>
  <li><b>ملاحظة:</b> يتم احترام الإقفال؛ لكن العرض مسموح حسب الصلاحية.</li>
</ul>

<h4>18.1.3 تحليل أداء (نسب نجاح/رسوب ومقارنة شعب)</h4>
<ul>
  <li><b>فلاتر:</b> عام، فصل، صف، مادة.</li>
  <li><b>مخرجات:</b> نسب + رسوم بيانية (اختياري) + CSV/Excel.</li>
  <li><b>الصلاحيات:</b> reports.academic.analytics.</li>
</ul>

<h3>18.2 تقارير الحضور</h3>

<h4>18.2.1 تقرير الغياب اليومي</h4>
<ul>
  <li><b>فلاتر:</b> تاريخ، صف/شعبة، حالة (غائب/متأخر/مستأذن).</li>
  <li><b>أعمدة:</b> الطالب، الحالة، السبب/العذر، من أدخل.</li>
  <li><b>الصلاحيات:</b> attendance.view + نطاقات المدرسة.</li>
</ul>

<h4>18.2.2 تقرير الغياب التراكمي للطالب</h4>
<ul>
  <li><b>فلاتر:</b> طالب، فترة، نوع الغياب.</li>
  <li><b>الصلاحيات:</b> attendance.view.student (حسب سياسة المدرسة).</li>
</ul>

<h3>18.3 تقارير إدارية وموارد</h3>
<ul>
  <li>ملف المدرسة (مرافق/تجهيزات/مياه/كهرباء…)</li>
  <li>إحصاءات القوى العاملة حسب التصنيف/المؤهل/التخصص.</li>
  <li>إحصاءات الطلاب حسب الصف/الجنس/الشعب + المتسربين.</li>
</ul>

<h4>18.3.1 مبادئ عامة للتقارير</h4>
<ul>
  <li><b>مستويات الوصول:</b> كل تقرير مرتبط بصلاحية (reports.*) وبنطاق (Own/Department/School).</li>
  <li><b>تنسيقات الإخراج:</b> شاشة + PDF + Excel حسب دور المستخدم.</li>
  <li><b>التدقيق:</b> تنزيل/طباعة تقارير حساسة يمكن تسجيله كحدث في Audit (اختياري حسب سياسة المدرسة).</li>
</ul>

<h3>18.4 تقارير مالية (داخل المدرسة فقط)</h3>
<ul>
  <li>التحصيل، المتأخرات، المصروفات، الرواتب، ملخص دخل/مصروف.</li>
</ul>

<h2>19) ما يُرسل لمكتب التربية (بدون مالية) — تفصيل</h2>

<h3>19.1 مبادئ الإرسال</h3>
<ul>
  <li><b>بدون مالية:</b> لا تُرسل أي بيانات مالية (إيصالات/رواتب/قيود/غرامات).</li>
  <li><b>حِزم موقّعة:</b> كل إرسال يكون عبر Report Package يحتوي بيانات + metadata + رقم إصدار schema.</li>
  <li><b>إقفال أكاديمي قبل الإرسال:</b> لا يسمح بإرسال نتائج فصل/سنة قبل إقفال الدرجات للفترة المحددة.</li>
</ul>

<h3>19.2 أنواع الحزم (Packages)</h3>
<ul>
  <li><b>SchoolProfilePackage:</b> ملف المدرسة (تعريف/مرافق/تجهيزات) وتحديثاته.</li>
  <li><b>HRStatsPackage:</b> ملخص القوى العاملة (أعداد حسب تصنيف/مؤهل/تخصص) بدون بيانات حساسة فردية إن لم يُطلب.</li>
  <li><b>TermResultsPackage:</b> نتائج الفصل (قوائم الطلاب + الدرجات بحسب سياسة الإرسال).</li>
  <li><b>YearResultsPackage:</b> نتائج نهاية السنة.</li>
</ul>

<h3>19.3 خطوات إنشاء الحزمة وإرسالها (Workflow)</h3>
<ol>
  <li><b>تحديد النوع والفترة:</b> اختيار نوع الحزمة (فصل/سنة/ملف مدرسة…) وتحديد العام والفصل.</li>
  <li><b>التحقق قبل التوليد:</b>
    <ul>
      <li>التأكد من اكتمال البيانات المطلوبة (صفوف/شعب/طلاب/درجات مكتملة).</li>
      <li>التأكد من الإقفال للفترة (خاصة نتائج الفصل/السنة).</li>
    </ul>
  </li>
  <li><b>توليد الحزمة:</b> إنشاء ملف بيانات (JSON) + metadata (schemaVersion, generatedAt, schoolId, academicYearId, termId).</li>
  <li><b>اعتماد الإرسال:</b> تنفيذ مسار اعتماد المدرسة لعملية submit.reportPackage (قد يكون مدير المدرسة/المخول).</li>
  <li><b>التوقيع/الختم:</b> إنشاء signature/hash للحزمة (حسب سياسة الأمان المعتمدة).</li>
  <li><b>الإرسال:</b> رفع الحزمة إلى API الخاص بالمكتب مع رقم تتبع.</li>
  <li><b>استلام رد المكتب:</b> Accepted/Rejected مع تفاصيل الأخطاء.</li>
  <li><b>المعالجة بعد الرفض:</b> فتح “جلسة تصحيح” داخل المدرسة ثم إعادة إرسال نسخة جديدة (increment packageVersion) مع الاحتفاظ بتاريخ النسخ.</li>
</ol>

<h3>19.4 ما الذي يُسجل في التدقيق</h3>
<ul>
  <li><b>من أنشأ الحزمة</b> ومن اعتمدها ومن أرسلها.</li>
  <li><b>المعلمات:</b> نوع الحزمة، الفترة، schemaVersion، packageVersion.</li>
  <li><b>النتيجة:</b> Accepted/Rejected وتفاصيل الرفض.</li>
</ul>

<hr />
<p class="small">نهاية الوثيقة — School Instance Specification</p>

</body>
</html>
